var NeptuneMaps={};NeptuneMaps.Map=function(n,t){var f=this,l,u,i,h;this.MapDivId=n.MapDivID;var e={maxNativeZoom:18,maxZoom:22},a=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",e),v=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",e),y=L.tileLayer.wms("https://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",e),c=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}",{}),o={Aerial:a,Street:v,Terrain:y},s={"Street Labels":c},r;for(t==="Hybrid"?(r=new L.LayerGroup,t="Aerial",c.addTo(r)):(Sitka.Methods.isUndefinedNullOrEmpty(t)||o[t]==null)&&(t="Terrain"),l={scrollWheelZoom:!0,layers:[o[t]],attributionControl:!1,fullscreenControl:n.AllowFullScreen?{pseudoFullscreen:!0}:!1},this.map=L.map(this.MapDivId,l),r!=null&&r.addTo(this.map),this.vectorLayers=[],u=0;u<n.Layers.length;++u){i=n.Layers[u];switch(i.LayerType){case"Vector":this.addVectorLayer(i,s);break;case"Wms":this.addWmsLayer(i,s);break;default:console.error("Invalid LayerType "+i.LayerType+" not added to map layers.")}}if(this.addLayersToMapLayersControl(o,s),h=jQuery(".modal"),!Sitka.Methods.isUndefinedNullOrEmpty(h))h.on("shown.bs.modal",function(){f.map.invalidateSize();f.setMapBounds(n)});f.setMapBounds(n)};NeptuneMaps.Map.prototype.addVectorLayer=function(n,t){var i=this,r=new L.LayerGroup,u=L.geoJson(n.GeoJsonFeatureCollection,{pointToLayer:function(t,i){var r=t.properties.FeatureColor==null?n.LayerColor:t.properties.FeatureColor;return L.marker(i,{icon:L.MakiMarkers.icon({icon:"marker",color:r,size:"s"})})},style:function(t){var i=_.includes(["Polygon","MultiPolygon"],t.geometry.type);return{color:t.properties.FeatureColor==null?n.LayerColor:t.properties.FeatureColor,weight:t.properties.FeatureWeight==null?2:t.properties.FeatureWeight,fill:t.properties.FillPolygon==null?i:t.properties.FillPolygon,fillOpacity:t.properties.FillOpacity==null?0:t.properties.FillOpacity}},onEachFeature:function(n,t){i.bindPopupToFeature(t,n)}}).addTo(r);if(n.LayerInitialVisibility===1&&r.addTo(this.map),n.HasClickThrough)u.on("click",function(n){i.clickThroughFeature(n)});else if(!n.HasCustomPopups)u.on("click",function(n){i.getFeatureInfo(n)});t[n.LayerName]=r;this.vectorLayers.push(u)};NeptuneMaps.Map.prototype.addWmsLayer=function(n,t){var i=new L.LayerGroup,r=L.Util.extend(this.wmsParams,{layers:n.MapServerLayerName}),u=L.tileLayer.wms(n.MapServerUrl,r).addTo(i);n.LayerInitialVisibility===1&&i.addTo(this.map);t[n.LayerName]=i;this.vectorLayers.push(u)};NeptuneMaps.Map.prototype.wmsParams={service:"WMS",transparent:!0,version:"1.1.1",format:"image/png",info_format:"application/json",tiled:!0};NeptuneMaps.Map.prototype.wfsParams={service:"WFS",version:"2.0",request:"GetFeature",outputFormat:"application/json",SrsName:"EPSG:4326"};NeptuneMaps.Map.prototype.addLayersToMapLayersControl=function(n,t){var i;this.layerControl=L.control.layers(n,t,{collapsed:!1});this.layerControl.addTo(this.map);i=L.DomUtil.create("a","leaflet-control-layers-close");i.innerHTML="Close";L.DomEvent.on(i,"click",function(){jQuery(".leaflet-control-layers").removeClass("leaflet-control-layers-expanded");jQuery(".leaflet-control-layers-close").toggle()});jQuery(".leaflet-control-layers-toggle").on("click",function(){jQuery(".leaflet-control-layers-close").toggle()});jQuery(".leaflet-control-layers").append(i)};NeptuneMaps.Map.prototype.setMapBounds=function(n){this.map.fitBounds([[n.BoundingBox.Northeast.Latitude,n.BoundingBox.Northeast.Longitude],[n.BoundingBox.Southwest.Latitude,n.BoundingBox.Southwest.Longitude]])};NeptuneMaps.Map.prototype.bindPopupToFeature=function(n,t){if(!Sitka.Methods.isUndefinedNullOrEmpty(t.properties.PopupUrl)){n.bindPopup("Loading...",{maxWidth:600});n.on("click",function(){jQuery.get(t.properties.PopupUrl).done(function(t){n.bindPopup(t).openPopup()})})}};NeptuneMaps.Map.prototype.assignClickEventHandler=function(n){for(var r,i=this,t=0;t<this.vectorLayers.length;++t){r=this.vectorLayers[t];r.on("click",function(t){n(i,t)})}this.map.on("click",function(t){n(i,t)})};NeptuneMaps.Map.prototype.removeClickEventHandler=function(){for(var t,n=0;n<this.vectorLayers.length;++n)t=this.vectorLayers[n],t.off("click");this.map.off("click")};NeptuneMaps.Map.prototype.getFeatureInfo=function(n){var h=this,r=n.latlng,i="<div>",f,e,u,t,o,s;for(i+=this.formatLayerProperty("Latitude",L.Util.formatNum(r.lat,4)),i+=this.formatLayerProperty("Longitude",L.Util.formatNum(r.lng,4)),f=_(this.vectorLayers).filter(function(n){return typeof n.eachLayer!="undefined"&&h.map.hasLayer(n)}).map(function(n){return leafletPip.pointInLayer(r,n,!0)}).flatten().value(),e=_(f).map(function(n){return _.keys(n.feature.properties)}).flatten().uniq().map(function(n){return{key:n,values:_(f).map(function(t){return t.feature.properties[n]}).filter().value()}}).value(),u=0;u<e.length;u++)t=e[u],t.key!=="Short Name"&&(o=t.values.length>1?t.key+"s":t.key,s=t.values.join(", "),i+=this.formatLayerProperty(o,s));i+="<\/div>";this.map.openPopup(L.popup({minWidth:200,maxWidth:350}).setLatLng(r).setContent(i).openOn(this.map))};NeptuneMaps.Map.prototype.clickThroughFeature=function(n){var i=this,r=n.latlng,u=_(this.vectorLayers).filter(function(n){return typeof n.eachLayer!="undefined"&&i.map.hasLayer(n)}).map(function(n){return leafletPip.pointInLayer(r,n,!0)}).flatten().value(),f=u.pop().feature,t=f.properties["Target URL"];Sitka.Methods.isUndefinedNullOrEmpty(t)||(window.location.href=t)};NeptuneMaps.Map.prototype.formatLayerProperty=function(n,t){return Sitka.Methods.isUndefinedNullOrEmpty(t)&&(t="&nbsp"),'<div class="row"><div class="col-xs-4"><strong>'+n+'<\/strong><\/div><div class="col-xs-8">'+t+"<\/div><\/div>"};NeptuneMaps.Map.prototype.removeLayerFromMap=function(n){Sitka.Methods.isUndefinedNullOrEmpty(n)||this.map.removeLayer(n)};NeptuneMaps.Map.prototype.addLayerToLayerControl=function(n,t,i){this.layerControl.addOverlay(n,t);i&&this.map.removeLayer(n)};NeptuneMaps.Map.prototype.setSelectedFeature=function(n,t){Sitka.Methods.isUndefinedNullOrEmpty(this.lastSelected)||this.map.removeLayer(this.lastSelected);console.log(n.properties);this.lastSelected=L.geoJson(n,{pointToLayer:function(n,t){var i=L.MakiMarkers.icon({icon:"marker",color:"#FFFF00",size:"m"});return L.marker(t,{icon:i,riseOnHover:!0})},style:function(){return{fillColor:"#FFFF00",fill:!0,fillOpacity:.4,color:"#FFFF00",weight:5,stroke:!0}}});this.lastSelected.addTo(this.map);t&&t(n)};NeptuneMaps.Map.prototype.zoomAndPanToLayer=function(n){n.getLatLng?(this.map.panTo(n.getLatLng()),this.map.fitBounds(L.latLngBounds([n.getLatLng()]),{maxZoom:18})):n.getBounds().isValid()&&this.map.fitBounds(n.getBounds(),{maxZoom:18})};NeptuneMaps.Map.prototype.deselect=function(){Sitka.Methods.isUndefinedNullOrEmpty(this.lastSelected)||this.map.removeLayer(this.lastSelected)};NeptuneMaps.Map.prototype.disableUserInteraction=function(){this.map.dragging.disable();this.map.touchZoom.disable();this.map.doubleClickZoom.disable();this.map.scrollWheelZoom.disable();this.map.boxZoom.disable();this.map.keyboard.disable()};NeptuneMaps.Map.prototype.enableUserInteraction=function(){this.map.dragging.enable();this.map.touchZoom.enable();this.map.doubleClickZoom.enable();this.map.scrollWheelZoom.enable();this.map.boxZoom.enable();this.map.keyboard.enable()};NeptuneMaps.Map.prototype.blockMapImpl=function(){this.map.dragging.disable();this.map.scrollWheelZoom.disable();jQuery("#"+this.MapDivId).block({message:"<span style='font-weight: bold; font-size: 14px; margin: 0 2px'>Location Not Specified<\/span>",css:{border:"none",cursor:"default"},overlayCSS:{backgroundColor:"#D3D3D3",cursor:"default"},baseZ:999})};NeptuneMaps.Map.prototype.blockMap=function(){var t=this,n;this.blockMapImpl();n=jQuery(".modal");n.on("shown.bs.modal",function(){t.blockMapImpl()})};NeptuneMaps.Map.prototype.unblockMap=function(){this.map.dragging.enable();jQuery("#"+this.MapDivId).unblock()};NeptuneMaps.Map.prototype.addEsriReferenceLayer=function(n,t,i){var r=L.esri.featureLayer({url:n});i&&r.bindPopup(i);this.addLayerToLayerControl(r,t)};NeptuneMaps.Map.prototype.addEsriDynamicLayer=function(n,t){var r=this.map.createPane("esriPane"),i;return r.style.zIndex=300,i=L.esri.dynamicMapLayer({url:n}),this.addLayerToLayerControl(i,t),i.addTo(this.map),i};NeptuneMaps.Map.prototype.makeMarkerClusterGroup=function(n){var t=L.markerClusterGroup({maxClusterRadius:40,showCoverageOnHover:!1,iconCreateFunction:function(n){return new L.DivIcon({html:"<div><span>"+n.getChildCount()+"<\/span><\/div>",className:"treatmentBMPCluster",iconSize:new L.Point(40,40)})}});return n.addTo(t),this.addLayerToLayerControl(t,"Treatment BMPs"),t.addTo(this.map),t};NeptuneMaps.Constants={defaultPolyColor:"#4242ff",defaultSelectedFeatureColor:"#ffff00",spatialReference:4326};NeptuneMaps.DefaultOptions={pointToLayer:function(n,t){var i=L.MakiMarkers.icon({icon:n.properties.FeatureGlyph,color:n.properties.FeatureColor,size:"m"});return L.marker(t,{icon:i,title:n.properties.Name,alt:n.properties.Name})}};L.Control.Watermark=L.Control.extend({onAdd:function(){var n=L.DomUtil.create("img");return n.src="/Content/img/OCStormwater/banner_logo.png",n.style.width="200px",n},onRemove:function(){jQuery(this.parentElement).remove()}});L.control.watermark=function(n){return new L.Control.Watermark(n)};