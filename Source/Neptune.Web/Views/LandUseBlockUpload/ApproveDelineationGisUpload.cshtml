@using LtInfo.Common
@using Newtonsoft.Json
@using Newtonsoft.Json.Linq
@inherits Neptune.Web.Views.LandUseBlockUpload.ApproveLandUseBlockGisUpload

@Html.ValidationSummary()

<div class="formPage">
    <div>
        <label class="col-md-2" for="@Html.IdFor(x => x.StormwaterJurisdictionID)">
            Jurisdiction
        </label>
        <div class="col-md-10">
            @Html.DropDownListFor(x => x.StormwaterJurisdictionID, ViewDataTyped.StormwaterJurisdictionSelectListItems, new Dictionary<string, object> {{"style", "width:auto;"}, {"class", "form-control"}})
        </div>
        <table class="table table-striped">
            <thead>
            <tr>
                <th></th>
                @if (Model.LandUseBlockGeometryLayers.Count > 1)
                {
                    <th>Import?</th>
                }
                <th>Feature Class</th>
                <th>BMP Name Field</th>
            </tr>
            </thead>
            <tbody>
            @if (Model.LandUseBlockGeometryLayers != null)
            {
                for (var i = 0; i < Model.LandUseBlockGeometryLayers.Count; i++)
                {
                    <tr>
                        <td>
                            <div style="height: 20px; width: 20px; background-color: @ViewDataTyped.LayerColors[Model.LandUseBlockGeometryLayers[i].LandUseBlockGeometryStagingID];"></div>
                            @Html.HiddenFor(x => x.LandUseBlockGeometryLayers[i].LandUseBlockGeometryStagingID)
                            @if (Model.LandUseBlockGeometryLayers.Count == 1)
                            {
                                <input type="hidden" value="@Model.LandUseBlockGeometryLayers[i].LandUseBlockGeometryStagingID" name="@Html.NameFor(x => x.LayerToImportID)"/>
                            }
                        </td>
                        @if (Model.LandUseBlockGeometryLayers.Count > 1)
                        {
                            <td class="text-center">
                                <input type="radio" value="@Model.LandUseBlockGeometryLayers[i].LandUseBlockGeometryStagingID" name="@Html.NameFor(x => x.LayerToImportID)"/>
                            </td>
                        }
                        <td>@ViewDataTyped.LandUseBlockGeometryFeatureClassNames[Model.LandUseBlockGeometryLayers[i].LandUseBlockGeometryStagingID]</td>
                        <td>
                            @Html.DropDownListFor(x => x.LandUseBlockGeometryLayers[i].SelectedProperty, ViewDataTyped.LandUseBlockGeometryLayerSelectProperties[Model.LandUseBlockGeometryLayers[i].LandUseBlockGeometryStagingID], new Dictionary<string, object> {{"style", "width:auto;"}, {"class", "form-control selectedProperty"}, {"data-landUseBlockGeometryStagingID", Model.LandUseBlockGeometryLayers[i].LandUseBlockGeometryStagingID.ToString()}})
                        </td>
                    </tr>
                }
            }
            </tbody>
        </table>
    </div>
    <div>
        <p>
            To zoom, hold <strong>Shift</strong> and drag rectangle.
        </p>
        <div id="@ViewDataTyped.MapInitJson.MapDivID" style="height: 400px;"></div>
        <div id="uploadGisReport"></div>
        <div class="text-right" style="margin-top: 15px;">
            <button id="submitApproveLandUseBlockGisUpload" type="submit" class="btn btn-neptune" disabled="disabled">Accept</button>
            <a href="@ViewDataTyped.LandUseBlockIndexUrl" class="btn btn-neptune">Cancel</a>
        </div>
    </div>
</div>

<script type="text/javascript" language="javascript">
    // <![CDATA[
    jQuery(function()
    {
        var mapInitJson = @Html.Raw(JObject.FromObject(ViewDataTyped.MapInitJson).ToString(Formatting.None)),
            map = new NeptuneMaps.Map(mapInitJson),

            landUseBlockStagingGeoJsons =
                @Html.Raw(JObject.FromObject(ViewDataTyped.LandUseBlockStagingGeoJsons).ToString(Formatting.None)),

            submitApproveLandUseBlockGisUploadButton = jQuery("#submitApproveLandUseBlockGisUpload"),

            landUseBlockUploadGisReports = [],

            uploadGisReportUrlTemplateString = @Html.Raw(ViewDataTyped.UploadGisReportUrlTemplate.ToJS()),
            uploadGisReportUrlTemplate = new Sitka.UrlTemplate(uploadGisReportUrlTemplateString);

        jQuery("#uploadGisReport").html("");
        jQuery("[name=@Html.NameFor(x => x.StormwaterJurisdictionID)],[name=@Html.NameFor(x => x.LayerToImportID)],[data-landUseBlockGeometryStagingID]")
            .on("change", updateLandUseBlockUploadPreview);

        function updateLandUseBlockUploadPreview()
        {
            var stormwaterJurisdictionID = jQuery("#@Html.IdFor(x => x.StormwaterJurisdictionID)").val(),
                landUseBlockGeometryStagingID =
                    jQuery("[type=radio][name=@Html.NameFor(x => x.LayerToImportID)]:checked,[type=hidden][name=@Html.NameFor(x => x.LayerToImportID)]").val(),
                selectedProperty = jQuery(".selectedProperty[data-landUseBlockGeometryStagingID=" +
                        landUseBlockGeometryStagingID +
                        "]")
                    .val();
            submitApproveLandUseBlockGisUploadButton.prop("disabled", true);

            if (!(Sitka.Methods.isUndefinedNullOrEmpty(stormwaterJurisdictionID) ||
                Sitka.Methods.isUndefinedNullOrEmpty(landUseBlockGeometryStagingID) ||
                Sitka.Methods.isUndefinedNullOrEmpty(selectedProperty)))
            {
                map.blockMap();
                pushWktAndAnnotationsToForm(landUseBlockGeometryStagingID, selectedProperty);
                
                var currentReport = _.find(landUseBlockUploadGisReports,
                {
                    StormwaterJurisdictionID: Number.parseInt(stormwaterJurisdictionID),
                    LandUseBlockGeometryStagingID: Number.parseInt(landUseBlockGeometryStagingID),
                    SelectedProperty: selectedProperty
                    });


                
                if (Sitka.Methods.isUndefinedNullOrEmpty(currentReport))
                {
                    var uploadGisReportUrl = uploadGisReportUrlTemplate
                        .ParameterReplace(stormwaterJurisdictionID,
                            landUseBlockGeometryStagingID,
                            selectedProperty);
                    jQuery.ajax(uploadGisReportUrl,
                    {
                        method: "POST",
                        data: {
                            StormwaterJurisdictionID: stormwaterJurisdictionID,
                            LandUseBlockGeometryStagingID: landUseBlockGeometryStagingID,
                            SelectedProperty: selectedProperty
                        },
                        success: function(data)
                        {
                            landUseBlockUploadGisReports.push(data);
                            handleValidReport(data);
                        },
                        error: function() {
                            
                            var report = {
                                StormwaterJurisdictionID: stormwaterJurisdictionID,
                                LandUseBlockGeometryStagingID: landUseBlockGeometryStagingID,
                                SelectedProperty: selectedProperty,
                                Errors: ["There was a problem fetching the report for this GIS upload."]
                            };
                            landUseBlockUploadGisReports.push(report);
                            handleValidReport(report);
                        },
                        complete: function() { map.unblockMap(); }
                    });
                }
                else
                {
                    handleValidReport(currentReport);
                    map.unblockMap();
                }
            }
            else
            {
                jQuery("#uploadGisReport").html("");
            }
        }

        function handleValidReport(report) {
            debugger;
            if (Sitka.Methods.isUndefinedNullOrEmpty(report.Errors))
            {
                submitApproveLandUseBlockGisUploadButton.prop("disabled", false);
                jQuery("#uploadGisReport")
                    .html(jQuery("#uploadGisReportTemplateHtml")
                        .html()
                        .replace("{{numberOfLandUseBlocks}}", report.NumberOfLandUseBlocks)
                        .replace("{{numberOfLandUseBlocksToBeUpdated}}", report.NumberOfLandUseBlocksToBeUpdated)
                        .replace("{{numberOfLandUseBlocksToBeCreated}}", report.NumberOfLandUseBlocksToBeCreated)
                        .replace("{{numberOfLandUseBlocksInActiveBMPRegistration}}",
                            report.NumberOfLandUseBlocksInActiveBMPRegistration));
            }
            else {
                _.forEach(report.Errors, function(err) { console.error(err); });
                jQuery("#uploadGisReport").html(jQuery("#uploadGisReportWarning").html());
            }
        }

        function pushWktAndAnnotationsToForm(landUseBlockGeometryStagingID, selectedProperty)
        {
            var approveGisUploadForm = jQuery("#approveGisUploadForm");
            jQuery(".wktAndAnnotation").remove();
            var geoJson = JSON.parse(landUseBlockStagingGeoJsons[Number
                .parseInt(landUseBlockGeometryStagingID)]);
            _.forEach(geoJson.features,
                function(feature, i)
                {
                    approveGisUploadForm
                        .append(jQuery("#wktAndAnnotationsTemplateHtml")
                            .html()
                            .replace(new RegExp("{{index}}", "g"), i)
                            .replace(new RegExp("{{wkt}}", "g"), Terraformer.WKT.convert(feature.geometry))
                            .replace(new RegExp("{{annotation}}", "g"), feature.properties[selectedProperty]));
                });
        }
    });
    // ]]>
</script>

<script type="text/html" id="uploadGisReportWarning">
    <div style="margin-top: 15px;">
        <div class="alert alert-warning" role="alert">
            There are problems with the selections for the layer you wish to import. Make sure that the <strong>Property</strong> selected is
            unambiguous (every feature has the selected property, and there are no duplicate values for features that have the selected property).
        </div>
    </div>
</script>
<script type="text/html" id="uploadGisReportTemplateHtml">
    <div style="margin-top: 15px;">
        <ul>
            <li>Layer contains {{numberOfLandUseBlocks}} landUseBlocks.</li>
            <li>{{numberOfLandUseBlocksToBeUpdated}} landUseBlock names match existing landUseBlocks in jurisdiction.</li>
            <li>{{numberOfLandUseBlocksToBeCreated}} new landUseBlocks will be created.</li>
        </ul>
    </div>
</script>
<script type="text/html" id="wktAndAnnotationsTemplateHtml">
    <input type="hidden" name="WktAndAnnotations[{{index}}].Wkt" value="{{wkt}}" class="wktAndAnnotation"/>
    <input type="hidden" name="WktAndAnnotations[{{index}}].Annotation" value="{{annotation}}" class="wktAndAnnotation"/>
</script>