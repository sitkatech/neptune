@using Neptune.Web.Views.Shared
@using LtInfo.Common.ModalDialog
@using LtInfo.Common.Mvc
@inherits Neptune.Web.Views.DelineationUpload.UpdateDelineationGeometry

@section JavascriptAndStylesContent
{
    @{ MapJavascriptIncludes.RenderPartialView(Html); }
}

@Html.ValidationSummary()

<div class="formPage">
    <div class="row">
        <div class="col-md-4">
            <p>
                Use this form to bulk upload Treatment BMP Delineations. Requirements:
            </p>
            <ul>
                <li>A single ArcGIS file geodatabase containing only delineation features</li>
                <li>The file geodatabase (.gdb) must be contained within a compressed zip file (.zip)</li>
                <li>The zip file must contain only one file geodatabase and no other data</li>
                <li>The file geodatabase must contain only one feature class</li>
                <li>The file must contain a field with Treatment BMP Name and all values must match a Treatment BMP name already in the Inventory Module</li>
                <li>
                    Geodatabases using ESRI Smart Database Compression (SDC) are not supported. Please
                    <a href="http://desktop.arcgis.com/en/arcmap/10.3/tools/data-management-toolbox/uncompress-file-geodatabase-data.htm">uncompress</a>
                    before zipping and uploading
                </li>
                <li>Version 10.1+ file geodatabases are supported</li>
            </ul>
            <form id="uploadGisForm" method="post" action="@ViewDataTyped.NewGisUploadUrl" enctype="multipart/form-data">
                <div>
                    @Html.EditorFor(x => x.FileResourceData)
                    @Html.ValidationMessageFor(x => x.FileResourceData)
                    <span class="smallExplanationText">
                        Allowed Extensions: @Model.GetFileExtensions(x => x.FileResourceData)
                    </span>
                </div>
            </form>
        </div>
        <div class="col-md-8">
            <p id="approvalInstructionsText">
                After you upload your file, you will be able to preview and verify the uploaded data on a map. Once you accept the uploaded data, new delineations will be added and any existing delineation locations with the same Treatment BMP name and specified Jurisdiction will be overwritten. All uploaded delineations will be marked as provisional.
            </p>
            <form id="approveGisUploadForm" method="post" action="@ViewDataTyped.ApprovedGisUploadUrl">
                <div id="gisUploadResults"></div>
            </form>
        </div>
    </div>
</div>



<script type="text/javascript">
    // <![CDATA[
    jQuery(function () {
        var $saveButton = jQuery("#@ModalDialogFormHelper.SaveButtonID");
        $saveButton.prop("disabled", true);
        jQuery("#@Html.IdFor(x => x.FileResourceData)").on("change", function () {
            var $form = jQuery("#uploadGisForm");
            if ($form.valid()) {
                var $gisUploadResults = jQuery("#gisUploadResults");
                $form.ajaxForm({
                    "url": this.action,
                    "type": this.method,
                    "beforeSubmit": function () { $gisUploadResults.html(jQuery("#progressBarHtml").html()); },
                    "success": function (result, textStatus, jqXhr) {
                        jQuery(".progress").hide();
                        jQuery("#approvalInstructionsText").hide();
                        SitkaAjax.handleLoginRedirect(result,
                            textStatus,
                            jqXhr,
                            function () {
                                $gisUploadResults.html(result);
                                $saveButton.prop("disabled", false);
                            });
                    },
                    "error": function (xhr, statusText) {
                        console.error("xhr: " + xhr + ", status: " + statusText);
                        jQuery(".progress").hide();
                        $saveButton.prop("disabled", true);
                        $gisUploadResults.html(jQuery("#gisUploadErrorHtml").html());
                    }
                });
                $form.submit();
            }
        });
    });

    // ]]>
</script>
<script id="progressBarHtml" type="text/html">
    <div style="padding-top: 10%">
        <div class="progress">
            <div class="progress-bar progress-bar-info progress-bar-striped active text-center" role="progressbar" style="width: 100%">
                Uploading &hellip;
            </div>
        </div>
    </div>
</script>
<script id="gisUploadErrorHtml" type="text/html">
    <div class="alert alert-danger" role="alert">
        There was a problem uploading your file geodatabase. Verify it meets the requirements and is not corrupt.
    </div>
</script>
