@using Neptune.Web.Views.Shared
@using LtInfo.Common.ModalDialog
@using LtInfo.Common.Mvc
@inherits Neptune.Web.Views.DelineationUpload.UpdateDelineationGeometry

@section JavascriptAndStylesContent
{
    @{ MapJavascriptIncludes.RenderPartialView(Html); }
}

@Html.ValidationSummary()

<div class="formPage">
    <div class="row">
        <div class="col-md-4">
            <p>
                You may provide an existing map of your existing catchment locations. Requirements:
            </p>
            <ul>
                <li>A single ArcGIS file geodatabase containing only features associated with the current project</li>
                <li>The file geodatabase (.gdb) must be contained within a compressed zip file (.zip)</li>
                <li>The zip file must contain only one file geodatabase and no other data</li>
                <li>
                    Geodatabased using ESRI Smart Database Compression (SDC) are not supported. Please
                    <a href="http://desktop.arcgis.com/en/arcmap/10.3/tools/data-management-toolbox/uncompress-file-geodatabase-data.htm">uncompress</a>
                    before zipping and uploading
                </li>
                <li>Version 10.1+ file geodatabases are supported</li>
            </ul>
            <p>
                After you upload your file, you will be able to preview and verify the uploaded data. Note that once you accept the uploaded data,
                any existing catchment locations with the same name and specified Jurisdiction will be overwritten.
            </p>
            <form id="uploadGisForm" method="post" action="@ViewDataTyped.NewGisUploadUrl" enctype="multipart/form-data">
                <div>
                    @Html.EditorFor(x => x.FileResourceData)
                    @Html.ValidationMessageFor(x => x.FileResourceData)
                    <span class="smallExplanationText">
                        Allowed Extensions: @Model.GetFileExtensions(x => x.FileResourceData)
                    </span>
                </div>
            </form>
        </div>
        <div class="col-md-8">
            <form id="approveGisUploadForm" method="post" action="@ViewDataTyped.ApprovedGisUploadUrl">
                <div id="gisUploadResults"></div>
            </form>
        </div>
    </div>
</div>



<script type="text/javascript">
    // <![CDATA[
    jQuery(function () {
        var $saveButton = jQuery("#@ModalDialogFormHelper.SaveButtonID");
        $saveButton.prop("disabled", true);
        jQuery("#@Html.IdFor(x => x.FileResourceData)").on("change", function () {
            var $form = jQuery("#uploadGisForm");
            if ($form.valid()) {
                var $gisUploadResults = jQuery("#gisUploadResults");
                $form.ajaxForm({
                    "url": this.action,
                    "type": this.method,
                    "beforeSubmit": function () { $gisUploadResults.html(jQuery("#progressBarHtml").html()); },
                    "success": function (result, textStatus, jqXhr) {
                        jQuery(".progress").hide();
                        SitkaAjax.handleLoginRedirect(result,
                            textStatus,
                            jqXhr,
                            function () {
                                $gisUploadResults.html(result);
                                $saveButton.prop("disabled", false);
                            });
                    },
                    "error": function (xhr, statusText) {
                        console.error("xhr: " + xhr + ", status: " + statusText);
                        jQuery(".progress").hide();
                        $saveButton.prop("disabled", true);
                        $gisUploadResults.html(jQuery("#gisUploadErrorHtml").html());
                    }
                });
                $form.submit();
            }
        });
    });
    // ]]>
</script>
<script id="progressBarHtml" type="text/html">
    <div style="padding-top: 10%">
        <div class="progress">
            <div class="progress-bar progress-bar-info progress-bar-striped active text-center" role="progressbar" style="width: 100%">
                Uploading &hellip;
            </div>
        </div>
    </div>
</script>
<script id="gisUploadErrorHtml" type="text/html">
    <div class="alert alert-danger" role="alert">
        There was a problem uploading your file geodatabase. Verify it meets the requirements and is not corrupt.
    </div>
</script>
