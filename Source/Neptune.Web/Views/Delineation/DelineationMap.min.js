"use strict";NeptuneMaps.DelineationMap=function(n,t,i){NeptuneMaps.GeoServerMap.call(this,n,t,i);this.treatmentBMPLayerLookup=new Map;var r=this.map.createPane("networkCatchmentPane");r.style.zIndex=1e4;this.map.getPane("markerPane").style.zIndex=10001;window.stormwaterNetworkLayer=this.addEsriDynamicLayer("https://ocgis.com/arcpub/rest/services/Flood/Stormwater_Network/MapServer/","Stormwater Network");window.networkCatchmentLayer=this.addWmsLayer("OCStormwater:NetworkCatchments","Network Catchments",{pane:"networkCatchmentPane"},function(n){this.selectFeatureByWfs({cql_filter:"intersects(CatchmentGeometry, POINT("+n.latlng.lat+" "+n.latlng.lng+"))"},"OCStormwater:NetworkCatchments",function(n){n.features[0]&&(this.setSelectedFeature(n.features[0]),this.selectedAssetControl.networkCatchment(n.features[0]))}.bind(this))}.bind(this));this.addWmsLayerWithParams("OCStormwater:Parcels","All Parcels",{styles:"parcel_alt",pane:"overlayPane"});this.initializeTreatmentBMPClusteredLayer(n);window.networkCatchmentLayer.bringToFront();L.control.watermark({position:"bottomleft"}).addTo(this.map);this.selectedAssetControl=L.control.delineationSelectedAsset({position:"topleft"});this.selectedAssetControl.addTo(this.map);this.hookupDeselectOnClick()};NeptuneMaps.DelineationMap.prototype=Sitka.Methods.clonePrototype(NeptuneMaps.GeoServerMap.prototype);NeptuneMaps.DelineationMap.prototype.addBeginDelineationControl=function(n){this.beginDelineationControl=L.control.beginDelineation({position:"bottomright"},n);this.beginDelineationControl.addTo(this.map);this.map.off("click")};NeptuneMaps.DelineationMap.prototype.removeBeginDelineationControl=function(){if(this.beginDelineationControl){this.beginDelineationControl.remove();this.beginDelineationControl=null;this.selectedAssetControl.enableDelineationButton();this.hookupDeselectOnClick();this.map.on("click",this.wmsLayers["OCStormwater:NetworkCatchments"].click)}};NeptuneMaps.DelineationMap.prototype.initializeTreatmentBMPClusteredLayer=function(n){this.treatmentBMPLayer=L.geoJson(n.TreatmentBMPLayerGeoJson.GeoJsonFeatureCollection,{pointToLayer:NeptuneMaps.DefaultOptions.pointToLayer,onEachFeature:function(n,t){this.treatmentBMPLayerLookup.set(n.properties.TreatmentBMPID,t)}.bind(this)});this.markerClusterGroup&&this.map.removeLayer(markerClusterGroup);this.markerClusterGroup=this.makeMarkerClusterGroup(this.treatmentBMPLayer);this.treatmentBMPLayer.on("click",function(n){this.removeUpstreamCatchmentsLayer();this.setSelectedFeature(n.layer.feature);this.selectedAssetControl.treatmentBMP(n.layer.feature);this.retrieveAndShowBMPDelineation(n.layer.feature)}.bind(this))};NeptuneMaps.DelineationMap.prototype.retrieveAndShowBMPDelineation=function(n){if(Sitka.Methods.isUndefinedNullOrEmpty(this.selectedBMPDelineationLayer)||this.map.removeLayer(this.selectedBMPDelineationLayer),n.properties.DelineationURL){var t=n.properties.DelineationURL;SitkaAjax.ajax({url:t,dataType:"json",jsonpCallback:"getJson"},function(n){n.type!=="Feature"&&delineationErrorAlert();this.addBMPDelineationLayer(n)}.bind(this),function(){delineationErrorAlert()})}};NeptuneMaps.DelineationMap.prototype.retrieveAndShowUpstreamCatchments=function(n){if(this.selectedAssetControl.disableUpstreamCatchmentsButton(),Sitka.Methods.isUndefinedNullOrEmpty(this.upstreamCatchmentsLayer)||this.map.removeLayer(this.upstreamCatchmentsLayer),n.properties.NetworkCatchmentID){var t="/NetworkCatchment/UpstreamCatchments/"+n.properties.NetworkCatchmentID;SitkaAjax.ajax({url:t,dataType:"json",jsonpCallback:"getJson"},this.processUpstreamCatchmentIDResponse.bind(this),function(){this.selectedAssetControl.enableUpstreamCatchmentsButton();upstreamCatchmentErrorAlert()}.bind(this))}};NeptuneMaps.DelineationMap.prototype.processUpstreamCatchmentIDResponse=function(n){if(this.selectedAssetControl.reportUpstreamCatchments(n.networkCatchmentIDs.length),n.networkCatchmentIDs.length===0){this.selectedAssetControl.enableUpstreamCatchmentsButton();return}var t=L.Util.extend(this.createWfsParamsWithLayerName("OCStormwater:NetworkCatchments"),{cql_filter:"NetworkCatchmentID IN ("+n.networkCatchmentIDs.toString()+")"});SitkaAjax.ajax({url:this.geoserverUrlOWS+L.Util.getParamString(t),dataType:"json",jsonpCallback:"getJson"},this.processUpstreamCatchmentGeoServerResponse.bind(this),function(){this.selectedAssetControl.enableUpstreamCatchmentsButton();upstreamCatchmentErrorAlert()}.bind(this))};NeptuneMaps.DelineationMap.prototype.processUpstreamCatchmentGeoServerResponse=function(n){this.selectedAssetControl.enableUpstreamCatchmentsButton();this.upstreamCatchmentsLayer=L.geoJSON(n,{style:function(){return{fillColor:"#4782ff",fill:!0,fillOpacity:.4,color:"#4782ff",weight:5,stroke:!0}}});this.upstreamCatchmentsLayer.addTo(this.map)};NeptuneMaps.DelineationMap.prototype.addBMPDelineationLayer=function(n){this.selectedBMPDelineationLayer=L.geoJson(n,{style:function(){return{fillColor:"#FFFF00",fill:!0,fillOpacity:.4,color:"#FFFF00",weight:5,stroke:!0}}});this.selectedBMPDelineationLayer.addTo(this.map)};NeptuneMaps.DelineationMap.prototype.removeBMPDelineationLayer=function(){Sitka.Methods.isUndefinedNullOrEmpty(this.selectedBMPDelineationLayer)||(this.map.removeLayer(this.selectedBMPDelineationLayer),this.selectedBMPDelineationLayer=null)};NeptuneMaps.DelineationMap.prototype.removeUpstreamCatchmentsLayer=function(){Sitka.Methods.isUndefinedNullOrEmpty(this.upstreamCatchmentsLayer)||(this.map.removeLayer(this.upstreamCatchmentsLayer),this.upstreamCatchmentsLayer=null)};NeptuneMaps.DelineationMap.prototype.preselectTreatmentBMP=function(n){if(n){var t=this.treatmentBMPLayerLookup.get(n);this.zoomAndPanToLayer(t);this.setSelectedFeature(t.feature);this.selectedAssetControl.treatmentBMP(t.feature);this.retrieveAndShowBMPDelineation(t.feature)}};NeptuneMaps.DelineationMap.prototype.hookupDeselectOnClick=function(){this.map.on("click",function(){this.deselect(function(){this.removeBMPDelineationLayer();this.removeUpstreamCatchmentsLayer();this.selectedAssetControl.reset()}.bind(this))}.bind(this))};var delineationErrorAlert=function(){alert("There was an error retrieving the BMP Delineation. Please try again. If the problem persists, please contact Support.")},upstreamCatchmentErrorAlert=function(){alert("There was an error retrieving the upstream catchments. Please try again. If the problem persists, please contact Support.")};