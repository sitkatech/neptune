function toast(n,t){jQuery.toast({top:8,text:n,hideAfter:3500,stack:1,icon:t,bgColor:"#707070",loaderBg:"#77cfdc"})}NeptuneMaps.DelineationMap=function(n,t,i,r,u){var f;NeptuneMaps.Map.call(this,n,t,i);configureProj4Defs();this.treatmentBMPLayerLookup=new Map;this.config=r;this.mapInitJson=n;this.delineationMapService=u;this.initializeTreatmentBMPClusteredLayer();this.addDelineationWmsLayers();f=this.map.createPane("regionalSubbasinPane");f.style.zIndex=1e4;this.map.getPane("markerPane").style.zIndex=10001;var e=this.addWmsLayer("OCStormwater:RegionalSubbasins","<span><img src='/Content/img/legendImages/regionalSubbasin.png' height='12px' style='margin-bottom:3px;' /> Regional Subbasins<\/span>",{pane:"regionalSubbasinPane"},!0);this.addWmsLayer("OCStormwater:Parcels","<span><img src='/Content/img/legendImages/parcel.png' height='14px'/> Parcels<\/span>",{styles:"parcel"},!0);e.bringToFront();this.addEsriDynamicLayer("https://ocgis.com/arcpub/rest/services/Flood/Stormwater_Network/MapServer/","<span>Stormwater Network <br/> <img src='/Content/img/legendImages/stormwaterNetwork.png' height='50'/> <\/span>",!1);L.control.watermark({position:"bottomleft"}).addTo(this.map);this.initializationsOnMapRefresh()};NeptuneMaps.DelineationMap.prototype=Sitka.Methods.clonePrototype(NeptuneMaps.Map.prototype);var TOLERANCE_CENTRALIZED=.0001,TOLERANCE_DISTRIBUTED=15e-6,TOLERANCE_STEP_INCREMENT=1e-6,DELINEATION_DISTRIBUTED="Distributed",DELINEATION_CENTRALIZED="Centralized",DELINEATION_VERIFIED="Verified",DELINEATION_PROVISIONAL="Provisional",STRATEGY_AUTODEM="AutoDEM",STRATEGY_NETWORK_TRACE="NetworkTrace",STRATEGY_MANUAL="Manual",LEAFLET_TO_GEO_JSON_PRECISION=18;NeptuneMaps.DelineationMap.prototype.initializationsOnMapRefresh=function(){this.hookupEditLocationOnclick();this.hookupSelectTreatmentBMPOnClick();this.hookupDeselectOnClick();this.hookupSelectTreatmentBMPByDelineation();this.hookupBringMarkerToFrontOnZoomEnd()};NeptuneMaps.DelineationMap.prototype.buildSelectedAssetControl=function(){this.selectedAssetControl=L.control.delineationSelectedAsset({position:"topleft"});this.selectedAssetControl.addTo(this.map);var n=document.querySelector("#selectedAssetControl");this.selectedAssetControl.parentElement.append(n)};NeptuneMaps.DelineationMap.prototype.addDelineationWmsLayers=function(){var n=this.config.JurisdictionCQLFilter,t,i,r,u,f,e;Sitka.Methods.isUndefinedNullOrEmpty(n)||(n=" AND "+n);n="";t="/Content/img/legendImages/delineationVerified.png";i="<span>Delineations (Verified) <\/br><img src='"+t+"'/><\/span>";this.verifiedLayer=this.addWmsLayer("OCStormwater:Delineations",i,{styles:"delineation",cql_filter:"DelineationStatus = 'Verified'"+n,maxZoom:22},!1);r="/Content/img/legendImages/delineationProvisional.png";u="<span>Delineations (Provisional) <\/br><img src='"+r+"'/><\/span>";this.provisionalLayer=this.addWmsLayer("OCStormwater:Delineations",u,{styles:"delineation",cql_filter:"DelineationStatus = 'Provisional'"+n,maxZoom:22},!0);f="/Content/img/legendImages/wqmp.png";e="<img src="+f+" style='height: 15px'/> WQMPs";this.WQMPsLayer=this.addWmsLayer("OCStormwater:WaterQualityManagementPlans",e,{maxZoom:22},!0)};NeptuneMaps.DelineationMap.prototype.cacheBustDelineationWmsLayers=function(){this.verifiedLayer.setParams({wmsParameterThatDoesNotExist:Date.now()},!1);this.provisionalLayer.setParams({wmsParameterThatDoesNotExist:Date.now()},!1)};NeptuneMaps.DelineationMap.prototype.initializeTreatmentBMPClusteredLayer=function(){var t=this.mapInitJson,n;this.treatmentBMPLayer=L.geoJson(t.TreatmentBMPLayerGeoJson.GeoJsonFeatureCollection,{pointToLayer:NeptuneMaps.DefaultOptions.pointToLayer,onEachFeature:function(n,t){this.treatmentBMPLayerLookup.set(n.properties.TreatmentBMPID,t)}.bind(this)});this.markerClusterGroup&&this.map.removeLayer(this.markerClusterGroup);this.markerClusterGroup=this.makeMarkerClusterGroup(this.treatmentBMPLayer);n="<span><img src='/Content/leaflet/images/marker-icon-2x-orange.png' height='30px' /> Treatment BMPs<\/span>";this.layerControl.addOverlay(this.markerClusterGroup,n)};NeptuneMaps.DelineationMap.prototype.preselectTreatmentBMP=function(n){if(n){var i=this.treatmentBMPLayerLookup.get(n),r=this.retrieveAndShowBMPDelineation(i.feature),t=this;r.then(function(){var n,r;return t.selectedBMPDelineationLayer?(n=t.selectedBMPDelineationLayer.getLayers()[0].feature.properties.DelineationStatus,t.delineationMapService.adjustZoom(t.selectedBMPDelineationLayer)):(n="None",r=i.feature.geometry.coordinates,t.map.setView([r[1],r[0]],18)),t.delineationMapService.broadcastDelineationMapState({selectedTreatmentBMPFeature:i.feature}),t.selectedAssetControl.treatmentBMP(i.feature,n),jQuery.Deferred().resolve()}).always(function(){setTimeout(function(){t.setSelectedFeature(i.feature)},500)})}};NeptuneMaps.DelineationMap.prototype.adjustZoom=function(n){this.map.fitBounds(n.getBounds())};NeptuneMaps.DelineationMap.prototype.hookupBringMarkerToFrontOnZoomEnd=function(){};NeptuneMaps.DelineationMap.prototype.getSelectedBMPFeature=function(){return this.lastSelected.toGeoJSON(LEAFLET_TO_GEO_JSON_PRECISION).features[0]};NeptuneMaps.DelineationMap.prototype.getSelectedBMPID=function(){return this.lastSelected.toGeoJSON().features[0].properties.TreatmentBMPID};NeptuneMaps.DelineationMap.prototype.addBeginDelineationControl=function(){var n=this.getSelectedBMPFeature();this.beginDelineationControl||(this.beginDelineationControl=L.control.beginDelineation({position:"bottomright"},n),this.beginDelineationControl.addTo(this.map),this.beginDelineationControl.preselectDelineationType(n.properties.DelineationType),this.beginDelineationControl.displayDelineationOptionsForFlowOption(n.properties.DelineationType),this.disableSelectOnClick())};NeptuneMaps.DelineationMap.prototype.removeBeginDelineationControl=function(){this.beginDelineationControl&&(this.beginDelineationControl.remove(),this.beginDelineationControl=null,this.enableUserInteraction(),this.enableSelectOnClick(),this.delineationMapService.resetDelineationMapEditingState(),window.freeze=!1)};NeptuneMaps.DelineationMap.prototype.launchEditLocationMode=function(){this.disableSelectOnClick();this.enableEditLocationOnClick();jQuery("#delineationMap").css("cursor","crosshair")};NeptuneMaps.DelineationMap.prototype.exitEditLocationMode=function(n){var i=this.getSelectedBMPFeature().properties.TreatmentBMPID,t,r,u;jQuery("#delineationMap").css("cursor","grab");t=this;n&&this.treatmentBMPLocationModel?(this.displayLoading(),r=new Sitka.UrlTemplate(this.config.TreatmentBMPLocationUrlTemplate).ParameterReplace(i),jQuery.ajax({url:r,data:t.treatmentBMPLocationModel,type:"POST"}).then(function(){var u=t.mapInitJson.TreatmentBMPLayerGeoJson.GeoJsonFeatureCollection.features,f=_.find(u,function(n){return n.properties.TreatmentBMPID==i}),r=f.geometry.coordinates,n;r[0]=t.treatmentBMPLocationModel.TreatmentBMPPointX;r[1]=t.treatmentBMPLocationModel.TreatmentBMPPointY;t.initializeTreatmentBMPClusteredLayer();n=t.treatmentBMPLayerLookup.get(i);t.setSelectedFeature(n.feature);t.retrieveAndShowBMPDelineation(n.feature).then(function(){var i;i=t.selectedBMPDelineationLayer?t.selectedBMPDelineationLayer.getLayers()[0].feature.properties.DelineationStatus:"None";t.selectedAssetControl.treatmentBMP(n.feature,i);t.delineationMapService.broadcastDelineationMapState({selectedTreatmentBMPFeature:n.feature})}).always(function(){t.removeLoading();t.initializationsOnMapRefresh();toast("Successfully updated Treatment BMP location.","success")})}).fail(function(){t.initializeTreatmentBMPClusteredLayer();var n=t.treatmentBMPLayerLookup.get(i);t.setSelectedFeature(n.feature);t.removeLoading();t.initializationsOnMapRefresh();toast("There was an error updating the Treatment BMP location.")})):(this.lastSelected.remove(),u=this.treatmentBMPLayerLookup.get(i),this.setSelectedFeature(u.feature));this.disableSelectOnClick();this.disableEditLocationOnClick();this.enableSelectOnClick()};NeptuneMaps.DelineationMap.prototype.launchDrawCatchmentMode=function(n){n.newDelineation=!this.selectedBMPDelineationLayer;this.disableEditLocationOnClick();this.beginDelineationControl&&(this.beginDelineationControl.remove(),this.beginDelineationControl=null);this.selectedBMPDelineationLayer&&this.delineationMapService.adjustZoom(this.selectedBMPDelineationLayer);this.selectedAssetControl.launchDrawCatchmentMode(n);this.delineationMapService.broadcastDelineationMapState({isInDelineationMode:!0,isEditedDelineationPresent:!0});this.buildDrawControl(n)};NeptuneMaps.DelineationMap.prototype.unthinDelineationVertices=function(){this.editableFeatureGroup.clearLayers();var n=this.editableFeatureGroup;L.geoJSON(this.delineationFeatureSavedForReset,{onEachFeature:function(t,i){i.getLayers?i.getLayers().forEach(function(t){n.addLayer(t)}):n.addLayer(i)}})};NeptuneMaps.DelineationMap.prototype.thinDelineationVertices=function(n,t){var i,r;this.delineationFeatureSavedForReset&&(i=this.editableFeatureGroup,this.editableFeatureGroup.clearLayers(),r=turf.flatten(downsampleGeoJsonFeature(this.delineationFeatureSavedForReset,t)),L.geoJSON(r,{onEachFeature:function(n,t){t.getLayers?t.getLayers().forEach(function(n){i.addLayer(n)}):i.addLayer(t)}}))};NeptuneMaps.DelineationMap.prototype.buildDrawControl=function(n){var u=this,t,f,r,i;if(this.editableFeatureGroup=new L.FeatureGroup,t=this.editableFeatureGroup,f=getDrawOptions(t),this.drawControl=new L.Control.Draw(f),this.map.addControl(this.drawControl),Sitka.Methods.isUndefinedNullOrEmpty(this.selectedBMPDelineationLayer)||(this.map.removeLayer(this.selectedBMPDelineationLayer),r=this.selectedBMPDelineationLayer.getLayers(),i=r.length>1?{type:"FeatureCollection",features:_.map(this.selectedBMPDelineationLayer.getLayers(),function(n){return n.feature})}:r[0].feature,this.delineationFeatureSavedForReset=i,i.geometry&&i.geometry.type==="MultiPolygon"&&(i=turf.flatten(i)),L.geoJSON(i,{onEachFeature:function(n,i){i.getLayers?i.getLayers().forEach(function(n){t.addLayer(n)}):t.addLayer(i)}})),this.map.addLayer(t),t.persist=!0,n.delineationStrategy===STRATEGY_NETWORK_TRACE)jQuery(".leaflet-draw-edit-edit").on("click",function(){t.persist||(t.persist=!0)});this.prepFeatureGroupAndDrawControl(n,!0);this.map.on("draw:created",function(i){var f=i.layer,r;t.addLayer(f);r=f._leaflet_id;t._layers[r].feature={};t._layers[r].feature.properties={};t._layers[r].feature.type="Feature";u.prepFeatureGroupAndDrawControl(n,!1)});this.map.on("draw:deleted",function(){u.prepFeatureGroupAndDrawControl(n,!1)})};NeptuneMaps.DelineationMap.prototype.prepFeatureGroupAndDrawControl=function(n,t){var i=this.editableFeatureGroup;i.getLayers().length>0?(killPolygonDraw(),t&&n.delineationStrategy!==STRATEGY_NETWORK_TRACE&&jQuery(".leaflet-draw-edit-edit").get(0).click()):(unKillPolygonDraw(),t&&n.delineationStrategy!==STRATEGY_NETWORK_TRACE&&jQuery(".leaflet-draw-draw-polygon").get(0).click())};NeptuneMaps.DelineationMap.prototype.tearDownDrawControl=function(){this.drawControl.remove();this.map.removeLayer(this.editableFeatureGroup);this.drawControl=null;this.editableFeatureGroup=null;this.delineationFeatureSavedForReset=null;this.networkTraceDelineationFeatureCollection=null};NeptuneMaps.DelineationMap.prototype.exitDrawCatchmentMode=function(n){n?(this.selectedAssetControl.flipVerifyButton(!1),this.selectedAssetControl.showVerifyButton(),this.treatmentBMPLayerLookup.get(this.getSelectedBMPFeature().properties.TreatmentBMPID).feature.properties.DelineationType=this.delineationType,this.persistDrawnCatchment()):this.selectedBMPDelineationLayer&&!this.selectedBMPDelineationLayer.isUnsavedDelineation?this.map.addLayer(this.selectedBMPDelineationLayer):this.selectedBMPDelineationLayer=null;this.tearDownDrawControl();this.retrieveAndShowBMPDelineation(this.getSelectedBMPFeature());this.enableUserInteraction();this.enableSelectOnClick();this.delineationMapService.resetDelineationMapEditingState(!0)};NeptuneMaps.DelineationMap.prototype.exitTraceMode=function(n){n?(this.selectedAssetControl.flipVerifyButton(!1),this.selectedAssetControl.showVerifyButton(),this.treatmentBMPLayerLookup.get(this.getSelectedBMPFeature().properties.TreatmentBMPID).feature.properties.DelineationType=this.delineationType,this.persistTracedCatchment()):this.selectedBMPDelineationLayer&&!this.selectedBMPDelineationLayer.isUnsavedDelineation?this.map.addLayer(this.selectedBMPDelineationLayer):(this.selectedBMPDelineationLayer&&(this.map.removeLayer(this.selectedBMPDelineationLayer),this.selectedBMPDelineationLayer=null),this.selectedBMPDelineationLayer=null);this.retrieveAndShowBMPDelineation(this.getSelectedBMPFeature());this.enableSelectOnClick()};NeptuneMaps.DelineationMap.prototype.persistDrawnCatchment=function(){var n,r;n=this.editableFeatureGroup.persist?this.editableFeatureGroup.toGeoJSON(LEAFLET_TO_GEO_JSON_PRECISION):this.selectedBMPDelineationLayer.getLayers()[0].feature;r=n.type==="Feature"?[Terraformer.WKT.convert(n.geometry)]:n.features.length==1?[Terraformer.WKT.convert(n.features[0].geometry)]:n.features.length>1?_.map(n.features,function(n){return Terraformer.WKT.convert(n.geometry)}):[Terraformer.WKT.convert({type:"Polygon"})];var i=this.getSelectedBMPFeature().properties.TreatmentBMPID,u=new Sitka.UrlTemplate(this.config.TreatmentBMPDelineationUrlTemplate).ParameterReplace(i),t=this;return jQuery.ajax({url:u,data:{WellKnownText:r,DelineationType:this.delineationType},type:"POST"}).then(function(n){t.treatmentBMPLayerLookup.get(i).feature.properties.DelineationURL=u;t.treatmentBMPLayerLookup.get(i).feature.properties.DelineationID=n.delineationID;t.retrieveAndShowBMPDelineation(t.getSelectedBMPFeature());t.cacheBustDelineationWmsLayers()}).fail(function(){alert("There was an error saving the delineation. Please try again. If the problem persists, please contact Support.")})};NeptuneMaps.DelineationMap.prototype.persistTracedCatchment=function(){var n=this.selectedBMPDelineationLayer.toGeoJSON(LEAFLET_TO_GEO_JSON_PRECISION),u=n.type==="Feature"?[Terraformer.WKT.convert(n.geometry)]:n.features.length==1?[Terraformer.WKT.convert(n.features[0].geometry)]:n.features.length>1?_.map(n.features,function(n){return Terraformer.WKT.convert(n.geometry)}):[Terraformer.WKT.convert({type:"Polygon"})];var i=this.getSelectedBMPFeature().properties.TreatmentBMPID,r=new Sitka.UrlTemplate(this.config.TreatmentBMPDelineationUrlTemplate).ParameterReplace(i),t=this;return jQuery.ajax({url:r,data:{WellKnownText:u,DelineationType:this.delineationType},type:"POST"}).then(function(n){t.treatmentBMPLayerLookup.get(i).feature.properties.DelineationURL=r;t.treatmentBMPLayerLookup.get(i).feature.properties.DelineationID=n.delineationID;t.retrieveAndShowBMPDelineation(t.getSelectedBMPFeature());t.cacheBustDelineationWmsLayers()}).fail(function(){alert("There was an error saving the delineation. Please try again. If the problem persists, please contact Support.")})};NeptuneMaps.DelineationMap.prototype.launchAutoDelineateMode=function(){var t;this.beginDelineationControl.remove();this.beginDelineationControl=null;t=this.lastSelected.getLayers()[0].getLatLng();this.disableUserInteraction();this.disableSelectOnClick();this.displayLoading();var n=this,i=new NeptuneMaps.DelineationMap.AutoDelineate(this.config.AutoDelineateBaseUrl),r=i.MakeDelineationRequestNew(t);r.then(function(t){var i=_.find(t.features,function(n){return n.properties.WshdType==="Total Upstream"}),r;if(i==null&&(i=_.find(t.features,function(n){return n.properties.WshdType==="Local Upstream"}),i==null)){window.alert("No total or local upstream returned from the remote service.  If the issue persists, please contact Support.");n.removeLoading();n.enableUserInteraction();n.enableSelectOnClick();n.delineationMapService.resetDelineationMapEditingState();return}n.addBMPDelineationLayerFromDEM(i);n.removeLoading();n.enableUserInteraction();r={tolerance:TOLERANCE_DISTRIBUTED,delineationType:DELINEATION_DISTRIBUTED,delineationStrategy:STRATEGY_AUTODEM};n.delineationMapService.broadcastDelineationMapState({isEditedDelineationPresent:!0});n.launchDrawCatchmentMode(r)}).fail(function(t){t||window.alert("There was an error retrieving the delineation from the remote service. If the issue persists, please contact Support.");t.messages&&_.find(t.messages,function(n){return n.description==="Number of intersecting catalog unit(s): 0"})?window.alert("The DEM service does not currently have data available near the selected Treatment BMP. If you would like to help expand the service to include your jurisdiction please contact the administrators to learn more."):t.serviceUnavailable?window.alert("The DEM service is currently unavailable. Please try again later."):window.alert("There was an error retrieving the delineation from the remote service. If the issue persists, please contact Support.");n.removeLoading();n.enableUserInteraction();n.enableSelectOnClick();n.delineationMapService.resetDelineationMapEditingState()})};NeptuneMaps.DelineationMap.prototype.launchTraceDelineateMode=function(){var t,n;this.delineationMapService.broadcastDelineationMapState({isEditingCentralizedDelineation:!0});Sitka.Methods.isUndefinedNullOrEmpty(this.selectedBMPDelineationLayer)||(this.map.removeLayer(this.selectedBMPDelineationLayer),this.selectedBMPDelineationLayer=null);this.beginDelineationControl.remove();this.beginDelineationControl=null;t=this.getSelectedBMPID();this.disableUserInteraction();this.disableSelectOnClick();this.displayLoading();n=this;this.retrieveDelineationFromNetworkTrace(t).then(function(t){n.processAndShowTraceDelineation(t);n.removeLoading();n.enableUserInteraction()}).fail(function(){n.removeLoading();n.enableUserInteraction();this.enableSelectOnClick();window.alert("There was an error retrieving the delineation from the Regional Subbasin Trace. Please try again. If the issue persists, please contact Support.")}).always(function(){n.removeLoading();n.enableUserInteraction()})};NeptuneMaps.DelineationMap.prototype.retrieveDelineationFromNetworkTrace=function(n){var t=new Sitka.UrlTemplate(this.config.CatchmentTraceUrlTemplate).ParameterReplace(n);return jQuery.ajax({url:t,type:"GET"})};NeptuneMaps.DelineationMap.prototype.processAndShowTraceDelineation=function(n){this.selectedBMPDelineationLayer&&(this.selectedBMPDelineationLayer.remove(),this.selectedBMPDelineationLayer=null);this.networkTraceDelineationFeatureCollection=n;this.selectedBMPDelineationLayer=L.geoJSON(n,{style:function(){return{fillColor:"#4782ff",fill:!0,fillOpacity:.4,color:"#4782ff",weight:5,stroke:!0}}});this.selectedBMPDelineationLayer.addTo(this.map);this.selectedBMPDelineationLayer.isUnsavedDelineation=!0;this.delineationMapService.broadcastDelineationMapState({isEditedDelineationPresent:!0})};NeptuneMaps.DelineationMap.prototype.addBMPDelineationLayer=function(n){this.selectedBMPDelineationLayer&&(this.map.removeLayer(this.selectedBMPDelineationLayer),this.selectedBMPDelineationLayer=null);this.selectedBMPDelineationLayer=L.geoJson(n,{style:function(){return{fillColor:"#FFFF00",fill:!0,fillOpacity:.4,color:"#FFFF00",weight:5,stroke:!0}}});this.selectedBMPDelineationLayer.addTo(this.map)};NeptuneMaps.DelineationMap.prototype.addBMPDelineationLayerFromDEM=function(n){this.selectedBMPDelineationLayer&&(this.selectedBMPDelineationLayer.remove(),this.selectedBMPDelineationLayer=null);var i,t=n.geometry;i=t.type==="Polygon"?t:{type:"Polygon",coordinates:t.coordinates[1]};this.selectedBMPDelineationLayer=L.geoJson(i,{style:function(){return{fillColor:"#FFFF00",fill:!0,fillOpacity:.4,color:"#FFFF00",weight:5,stroke:!0}}});this.selectedBMPDelineationLayer.addTo(this.map);this.selectedBMPDelineationLayer.isUnsavedDelineation=!0};NeptuneMaps.DelineationMap.prototype.removeBMPDelineationLayer=function(){Sitka.Methods.isUndefinedNullOrEmpty(this.selectedBMPDelineationLayer)||(this.map.removeLayer(this.selectedBMPDelineationLayer),this.selectedBMPDelineationLayer=null)};NeptuneMaps.DelineationMap.prototype.deleteDelineation=function(n){var i=this.getSelectedBMPFeature(),r=new Sitka.UrlTemplate(this.config.DeleteDelineationUrlTemplate).ParameterReplace(i.properties.TreatmentBMPID),t=this;this.postDelete=function(){jQuery.ajax({url:r,data:{},method:"POST"}).then(function(){t.delineationMapService.setDelineation(null);t.removeBMPDelineationLayer();t.cacheBustDelineationWmsLayers();n()}).fail(function(){window.alert("There was an error deleting the delineation. Please try again. If the issue persists, please contact support.")})};confirmDeleteDelineation(i.properties.Name)};NeptuneMaps.DelineationMap.prototype.retrieveAndShowBMPDelineation=function(n){if(this.delineationMapService.setDelineation(null),this.selectedBMPDelineationLayer&&(this.map.removeLayer(this.selectedBMPDelineationLayer),this.selectedBMPDelineationLayer=null),!n.properties.DelineationURL)return jQuery.Deferred().resolve();var i=n.properties.DelineationURL,t=this;return jQuery.ajax({url:i,dataType:"json",jsonpCallback:"getJson"}).then(function(n){n.noDelineation||(n.type!=="Feature"&&delineationErrorAlert(),t.delineationMapService.setDelineation(n),t.addBMPDelineationLayer(n),t.selectedAssetControl.showDeleteButton(),t.delineationMapService.broadcastDelineationMapState({}))}).fail(delineationErrorAlert)};NeptuneMaps.DelineationMap.prototype.changeDelineationStatus=function(n){var t=this.getSelectedBMPFeature().properties.DelineationID,i=new Sitka.UrlTemplate(this.config.ChangeDelineationStatusUrlTemplate).ParameterReplace(t),r=this;jQuery.ajax({url:i,method:"POST",data:{IsVerified:n}}).then(function(n){n.success?(r.cacheBustDelineationWmsLayers(),toast("The Delineation status was successfully changed.","success")):toast("There was an error changing the delineation status.","error")})};NeptuneMaps.DelineationMap.prototype.selectBMPByDelineation=function(n){var i=this.config.JurisdictionCQLFilter,r,t;Sitka.Methods.isUndefinedNullOrEmpty(i)?i="":i+=" AND ";r={cql_filter:i+"INTERSECTS(DelineationGeometry, POINT("+n.lat+" "+n.lng+")) AND DelineationType <> 'WQMP'"};t=this;this.getFeatureInfo("OCStormwater:Delineations",[n.lng,n.lat]).then(function(n){var r,u,i;n.totalFeatures===0||n.features&&n.features.length===0||(r=n.features[0],(r.properties.DelineationStatus===DELINEATION_VERIFIED&&t.map.hasLayer(t.verifiedLayer)||r.properties.DelineationStatus===DELINEATION_PROVISIONAL&&t.map.hasLayer(t.provisionalLayer))&&(u=r.properties.TreatmentBMPID,i=t.treatmentBMPLayerLookup.get(u),i&&(t.setSelectedFeature(i.feature),t.retrieveAndShowBMPDelineation(i.feature).then(function(){var n;n=t.selectedBMPDelineationLayer?t.selectedBMPDelineationLayer.getLayers()[0].feature.properties.DelineationStatus:"None";t.selectedAssetControl.treatmentBMP(i.feature,n)}),t.delineationMapService.broadcastDelineationMapState({selectedTreatmentBMPFeature:i.feature}))))})};NeptuneMaps.DelineationMap.prototype.disableSelectOnClick=function(){this.selectOnClickDisabled=!0};NeptuneMaps.DelineationMap.prototype.enableSelectOnClick=function(){this.selectOnClickDisabled=!1};NeptuneMaps.DelineationMap.prototype.hookupDeselectOnClick=function(){var n=this;this.map.on("click",function(){window.freeze||n.selectOnClickDisabled||(n.deselect(),n.removeBMPDelineationLayer(),n.delineationMapService.broadcastDelineationMapState({selectedTreatmentBMPFeature:null}))})};NeptuneMaps.DelineationMap.prototype.hookupSelectTreatmentBMPOnClick=function(){var n=this;this.treatmentBMPLayer.on("click",function(t){window.freeze||n.selectOnClickDisabled||(n.setSelectedFeature(t.layer.feature),n.retrieveAndShowBMPDelineation(t.layer.feature).then(function(){var i;i=n.selectedBMPDelineationLayer?n.selectedBMPDelineationLayer.getLayers()[0].feature.properties.DelineationStatus:"None";n.selectedAssetControl.treatmentBMP(t.layer.feature,i);n.delineationMapService.broadcastDelineationMapState({selectedTreatmentBMPFeature:t.layer.feature})}))})};NeptuneMaps.DelineationMap.prototype.hookupSelectTreatmentBMPByDelineation=function(){var n=this;this.map.on("click",function(t){window.freeze||n.selectOnClickDisabled||n.selectBMPByDelineation(t.latlng)})};NeptuneMaps.DelineationMap.prototype.disableEditLocationOnClick=function(){this.editLocationOnClickDisabled=!0};NeptuneMaps.DelineationMap.prototype.enableEditLocationOnClick=function(){this.editLocationOnClickDisabled=!1};NeptuneMaps.DelineationMap.prototype.hookupEditLocationOnclick=function(){var n=this;this.map.on("click",function(t){if(!(window.freeze||n.editLocationOnClickDisabled)){var i=t.latlng;n.lastSelectedMarker.setLatLng(i);n.treatmentBMPLocationModel={TreatmentBMPPointY:i.lat,TreatmentBMPPointX:i.lng}}});this.disableEditLocationOnClick()};NeptuneMaps.DelineationMap.prototype.displayLoading=function(){this.frosty=new L.LeafletLoading;this.frosty.addTo(this.map);this.map.spin(!0)};NeptuneMaps.DelineationMap.prototype.removeLoading=function(){this.frosty&&(this.frosty.remove(),this.frosty=null);this.map.spin(!1)};var downsampleGeoJsonFeature=function(n,t){return turf.simplify(n,{tolerance:t})},delineationErrorAlert=function(){window.alert("There was an error retrieving the BMP Delineation. Please try again. If the problem persists, please contact Support.")},upstreamCatchmentErrorAlert=function(){window.alert("There was an error retrieving the upstream catchments. Please try again. If the problem persists, please contact Support.")},getDrawOptions=function(n){return{position:"topleft",draw:{polyline:!1,polygon:{allowIntersection:!1,drawError:{color:"#e1e100",message:"Self-intersecting polygons are not allowed."}},circle:!1,rectangle:!1,marker:!1},edit:{featureGroup:n,edit:{maintainColor:!0,opacity:.3},remove:!0}}},killPolygonDraw=function(){jQuery(".leaflet-draw-toolbar-top").hide()},unKillPolygonDraw=function(){jQuery(".leaflet-draw-toolbar-top").show()},confirmDeleteDelineation=function(n){var i="<div class='modal neptune-modal' style='width: 500px; margin:auto;'><div class='modal-dialog neptune-modal-dialog'><div class='modal-content'><div class='modal-header'><button type='button' class='btn btn-xs btn-neptune modal-close-button' data-dismiss='modal'><span>&times<\/span><\/button><span class='modal-title'>Delete Delineation<\/span><\/div><div class='modal-body'><p>Are you sure you want to delete the delineation for BMP "+n+"?<\/p><\/div><div class='modal-footer'><button type='button' class='btn btn-neptune pull-right' data-dismiss='modal'>Cancel<\/button><button type='button' class='btn btn-neptune pull-right' style='margin-right:5px;' onclick='window.delineationMap.postDelete()' data-dismiss='modal'>Continue<\/a><\/div><\/div><\/div><\/div>",t=jQuery(i);t.modal({keyboard:!0});t.draggable({handle:".modal-header"})},configureProj4Defs=function(){proj4.defs([["EPSG:4326",'GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.01745329251994328,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]]'],["EPSG:2230",'PROJCS["NAD83 / California zone 6 (ftUS)",GEOGCS["NAD83",DATUM["North_American_Datum_1983",SPHEROID["GRS 1980",6378137,298.257222101,AUTHORITY["EPSG","7019"]],AUTHORITY["EPSG","6269"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.01745329251994328,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4269"]],UNIT["US survey foot",0.3048006096012192,AUTHORITY["EPSG","9003"]],PROJECTION["Lambert_Conformal_Conic_2SP"],PARAMETER["standard_parallel_1",33.88333333333333],PARAMETER["standard_parallel_2",32.78333333333333],PARAMETER["latitude_of_origin",32.16666666666666],PARAMETER["central_meridian",-116.25],PARAMETER["false_easting",6561666.667],PARAMETER["false_northing",1640416.667],AUTHORITY["EPSG","2230"],AXIS["X",EAST],AXIS["Y",NORTH]]']])};