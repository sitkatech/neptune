var NeptuneMaps={},BetterLayerControl;NeptuneMaps.Map=function(n,t,i,r){var h=this,f,e,o,p,l,w,s,u,a;this.geoserverUrlOWS=i;this.wmsLayers={};this.wmsParams={service:"WMS",transparent:!0,version:"1.1.1",format:"image/png",info_format:"application/json",tiled:!0};this.wfsParams={service:"WFS",version:"2.0",request:"GetFeature",outputFormat:"application/json",SrsName:"EPSG:4326"};this.MapDivId=n.MapDivID;var c={maxNativeZoom:18,maxZoom:22},b=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",c),k=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",c),d=L.tileLayer.wms("https://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",c),g=L.tileLayer.wms("https://wtb.maptiles.arcgis.com/arcgis/rest/services/World_Topo_Base/MapServer/tile/{z}/{y}/{x}",{maxNativeZoom:15,maxZoom:22}),v=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}",{}),y=L.vectorGrid.protobuf("https://tiles.arcgis.com/tiles/UXmFoWC7yDHcDN5Q/arcgis/rest/services/Contours_2ft/VectorTileServer/tile/{z}/{y}/{x}.pbf",{});for(y.id="Topography",f={Aerial:b,Street:k,Terrain:d,Hillshade:g},e={"Street Labels":v,Topography:y},t==="Hybrid"?(o=new L.LayerGroup,t="Aerial",v.addTo(o)):(Sitka.Methods.isUndefinedNullOrEmpty(t)||f[t]==null)&&(t="Terrain"),r||(r={}),this.customOptions=r,p={scrollWheelZoom:!0,layers:[f[t]],attributionControl:!1,fullscreenControl:n.AllowFullScreen?{pseudoFullscreen:!0}:!1},this.map=L.map(this.MapDivId,p),o!=null&&o.addTo(this.map),l=!1,this.customOptions.collapseLayerControl&&(l=!0),w={collapsed:l},this.layerControl=new BetterLayerControl(f,e,w),this.layerControl.addTo(this.map),this.vectorLayers=[],this.vectorLayerGroups=[],s=0;s<n.Layers.length;++s){u=n.Layers[s];switch(u.LayerType){case"Vector":this.addVectorLayer(u,e);break;case"Wms":this.addWmsLayer("OCStormwater:"+u.LayerName,u.LayerName);break;default:console.error("Invalid LayerType "+u.LayerType+" not added to map layers.")}}if(this.addLayersToMapLayersControl(f,e,n.LayerControlClass),a=jQuery(".modal"),!Sitka.Methods.isUndefinedNullOrEmpty(a))a.on("shown.bs.modal",function(){h.map.invalidateSize();h.setMapBounds(n)});h.setMapBounds(n);this.map.on("zoomend",NeptuneMaps.disableAppropriateControls)};NeptuneMaps.Map.prototype.buildDefaultLeafletMarkerFromMarkerPath=function(n){var t=n.replace("marker-icon","marker-icon-2x");return this.buildDefaultLeafletMarker(n,t)};NeptuneMaps.Map.prototype.buildDefaultLeafletMarker=function(n,t){return L.icon({iconRetinaUrl:t,iconUrl:n,shadowUrl:"/Content/leaflet/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],tooltipAnchor:[16,-28],shadowSize:[41,41]})};NeptuneMaps.Map.prototype.addVectorLayer=function(n,t){var r=this,i=new L.LayerGroup,u=L.geoJson(n.GeoJsonFeatureCollection,{pointToLayer:function(t,i){var u=t.properties.FeatureColor==null?n.LayerColor:t.properties.FeatureColor;return L.marker(i,{icon:r.buildDefaultLeafletMarkerFromMarkerPath("/Content/leaflet/images/marker-icon-orange.png")})},style:function(t){var i=_.includes(["Polygon","MultiPolygon"],t.geometry.type);return{color:t.properties.FeatureColor==null?n.LayerColor:t.properties.FeatureColor,weight:t.properties.FeatureWeight==null?2:t.properties.FeatureWeight,fill:t.properties.FillPolygon==null?i:t.properties.FillPolygon,fillOpacity:t.properties.FillOpacity==null?0:t.properties.FillOpacity}},onEachFeature:function(n,t){r.bindPopupToFeature(t,n)}}).addTo(i);if(n.LayerInitialVisibility==="Show"&&i.addTo(this.map),n.HasClickThrough)u.on("click",function(n){r.clickThroughFeature(n)});else if(!n.HasCustomPopups)u.on("click",function(){});t[n.LayerName]=i;this.vectorLayers.push(u);this.vectorLayerGroups.push(i)};NeptuneMaps.Map.prototype.addWmsLayer=function(n,t,i,r){var f=this.createWmsParamsWithLayerName(n),u;return i&&L.Util.extend(f,i),u=L.tileLayer.wms(this.geoserverUrlOWS,f).addTo(this.map),this.addLayerToLayerControl(u,t,r),u};NeptuneMaps.Map.prototype.createWmsParamsWithLayerName=function(n){var i={layers:n},t=jQuery.extend({},this.wmsParams);return L.Util.extend(t,i),t};NeptuneMaps.Map.prototype.createWfsParamsWithLayerName=function(n){var i={typeName:n},t=jQuery.extend({},this.wfsParams);return L.Util.extend(t,i),t};NeptuneMaps.Map.prototype.selectFeatureByWfs=function(n,t){var i=L.Util.extend(this.createWfsParamsWithLayerName(n),t);return jQuery.ajax({url:this.geoserverUrlOWS+L.Util.getParamString(i),type:"GET"})};NeptuneMaps.Map.prototype.getFeatureInfo=function(n,t){var i=t[0],r=t[1],u=i+.0001,f=r+.0001,e=[i,r,u,f].join(","),o={service:"WMS",transparent:!0,version:"1.1.1",request:"GetFeatureInfo",info_format:"application/json",tiled:!0,QUERY_LAYERS:n,layers:n,X:50,Y:50,SRS:"EPSG:4326",WIDTH:101,HEIGHT:101,BBOX:e};return jQuery.ajax({url:this.geoserverUrlOWS+L.Util.getParamString(o),type:"GET"})};BetterLayerControl=L.Control.Layers.extend({fixClass:function(n){this._container.className+=" ";this._container.className+=n},onAdd:function(n){this._map=n;n.on("zoomend",this._update,this);return L.Control.Layers.prototype.onAdd.call(this,n)},onRemove:function(n){n.off("zoomend",this._update,this);L.Control.Layers.prototype.onRemove.call(this,n)},_addItem:function(n){var t=L.Control.Layers.prototype._addItem.call(this,n);return this._map.getZoom()<14&&n.name==="Topography"&&$(t).find("input").addClass("disabled-control"),t}});NeptuneMaps.Map.prototype.addLayersToMapLayersControl=function(n,t,i){var o=!1,f;if(this.customOptions.collapseLayerControl&&(o=!0),!o){var r=".leaflet-control-layers",s="leaflet-control-layers-close",u=".leaflet-control-layers-close",e=".leaflet-control-layers-toggle";Sitka.Methods.isUndefinedNullOrEmpty(i)||(this.layerControl.fixClass(i),r="."+i,s+=" "+i+"-close",u="."+i+"-close",e="."+i+" "+e);f=L.DomUtil.create("a",s);f.innerHTML="Close";L.DomEvent.on(f,"click",function(){jQuery(r).removeClass("leaflet-control-layers-expanded");jQuery(u).toggle()});jQuery(e).on("click",function(){jQuery(u).toggle()});jQuery(r).append(f);this.closeMapLayersControl=function(){jQuery(r).removeClass("leaflet-control-layers-expanded");jQuery(u).toggle()}}};NeptuneMaps.Map.prototype.setMapBounds=function(n){this.map.fitBounds([[n.BoundingBox.Bottom,n.BoundingBox.Left],[n.BoundingBox.Top,n.BoundingBox.Right]])};NeptuneMaps.Map.prototype.bindPopupToFeature=function(n,t){if(!Sitka.Methods.isUndefinedNullOrEmpty(t.properties.PopupUrl)){n.bindPopup("Loading...",{maxWidth:600});n.on("click",function(){jQuery.get(t.properties.PopupUrl).done(function(t){n.bindPopup(t).openPopup()})})}};NeptuneMaps.Map.prototype.assignClickEventHandler=function(n){for(var r,i=this,t=0;t<this.vectorLayers.length;++t){r=this.vectorLayers[t];r.on("click",function(t){n(i,t)})}this.map.on("click",function(t){n(i,t)})};NeptuneMaps.Map.prototype.removeClickEventHandler=function(){for(var t,n=0;n<this.vectorLayers.length;++n)t=this.vectorLayers[n],t.off("click");this.map.off("click")};NeptuneMaps.Map.prototype.clickThroughFeature=function(n){var i=this,r=n.latlng,u=_(this.vectorLayers).filter(function(n){return typeof n.eachLayer!="undefined"&&i.map.hasLayer(n)}).map(function(n){return leafletPip.pointInLayer(r,n,!0)}).flatten().value(),f=u.pop().feature,t=f.properties["Target URL"];Sitka.Methods.isUndefinedNullOrEmpty(t)||(window.location.href=t)};NeptuneMaps.Map.prototype.formatLayerProperty=function(n,t){return Sitka.Methods.isUndefinedNullOrEmpty(t)&&(t="&nbsp"),'<div class="row"><div class="col-xs-4"><strong>'+n+'<\/strong><\/div><div class="col-xs-8">'+t+"<\/div><\/div>"};NeptuneMaps.Map.prototype.removeLayerFromMap=function(n){Sitka.Methods.isUndefinedNullOrEmpty(n)||this.map.removeLayer(n)};NeptuneMaps.Map.prototype.addLayerToLayerControl=function(n,t,i){this.layerControl.addOverlay(n,t);i&&this.map.removeLayer(n)};NeptuneMaps.Map.prototype.setSelectedFeature=function(n,t){Sitka.Methods.isUndefinedNullOrEmpty(this.lastSelected)||this.map.removeLayer(this.lastSelected);var i=this;this.lastSelected=L.geoJson(n,{pointToLayer:function(n,t){var r=$scope.neptuneMap.buildDefaultLeafletMarkerFromMarkerPath("/Content/leaflet/images/marker-icon-selected.png");return i.lastSelectedMarker=L.marker(t,{icon:r,riseOnHover:!0}),i.lastSelectedMarker},style:function(){return{fillColor:"#FFFF00",fill:!0,fillOpacity:.4,color:"#FFFF00",weight:5,stroke:!0}}});this.lastSelected.addTo(this.map);t&&t(n)};NeptuneMaps.Map.prototype.zoomAndPanToLayer=function(n){n.getLatLng?(this.map.panTo(n.getLatLng()),this.map.fitBounds(L.latLngBounds([n.getLatLng()]),{maxZoom:18})):n.getBounds().isValid()&&this.map.fitBounds(n.getBounds(),{maxZoom:18})};NeptuneMaps.Map.prototype.deselect=function(){Sitka.Methods.isUndefinedNullOrEmpty(this.lastSelected)||this.map.removeLayer(this.lastSelected)};NeptuneMaps.Map.prototype.disableUserInteraction=function(){this.map.dragging.disable();this.map.touchZoom.disable();this.map.doubleClickZoom.disable();this.map.scrollWheelZoom.disable();this.map.boxZoom.disable();this.map.keyboard.disable()};NeptuneMaps.Map.prototype.enableUserInteraction=function(){this.map.dragging.enable();this.map.touchZoom.enable();this.map.doubleClickZoom.enable();this.map.scrollWheelZoom.enable();this.map.boxZoom.enable();this.map.keyboard.enable()};NeptuneMaps.Map.prototype.blockMapImpl=function(){this.map.dragging.disable();this.map.scrollWheelZoom.disable();jQuery("#"+this.MapDivId).block({message:"<span style='font-weight: bold; font-size: 14px; margin: 0 2px'>Location Not Specified<\/span>",css:{border:"none",cursor:"default"},overlayCSS:{backgroundColor:"#D3D3D3",cursor:"default"},baseZ:999})};NeptuneMaps.Map.prototype.blockMap=function(){var t=this,n;this.blockMapImpl();n=jQuery(".modal");n.on("shown.bs.modal",function(){t.blockMapImpl()})};NeptuneMaps.Map.prototype.unblockMap=function(){this.map.dragging.enable();jQuery("#"+this.MapDivId).unblock()};NeptuneMaps.Map.prototype.addEsriReferenceLayer=function(n,t,i){var r=L.esri.featureLayer({url:n});i&&r.bindPopup(i);this.addLayerToLayerControl(r,t)};NeptuneMaps.Map.prototype.addEsriDynamicLayer=function(n,t,i){var u=this.map.createPane("esriPane"),r;return u.style.zIndex=300,r=L.esri.dynamicMapLayer({url:n}),this.addLayerToLayerControl(r,t),i&&r.addTo(this.map),r};NeptuneMaps.Map.prototype.makeMarkerClusterGroup=function(n){var t=L.markerClusterGroup({maxClusterRadius:40,showCoverageOnHover:!1,iconCreateFunction:function(n){return new L.DivIcon({html:"<div><span>"+n.getChildCount()+"<\/span><\/div>",className:"treatmentBMPCluster",iconSize:new L.Point(40,40)})}});return n.addTo(t),t.addTo(this.map),t};NeptuneMaps.Constants={defaultPolyColor:"#4242ff",defaultSelectedFeatureColor:"#ffff00",spatialReference:4326};L.Control.Watermark=L.Control.extend({onAdd:function(){var n=L.DomUtil.create("img");return n.src="/Content/img/OCStormwater/banner_logo.png",n.style.width="200px",n},onRemove:function(){jQuery(this.parentElement).remove()}});L.control.watermark=function(n){return new L.Control.Watermark(n)};NeptuneMaps.epsg4326ToEpsg2771=function(n){return proj4("+proj=lcc +lat_1=33.88333333333333 +lat_2=32.78333333333333 +lat_0=32.16666666666666 +lon_0=-116.25 +x_0=2000000 +y_0=500000 +ellps=GRS80 +units=m +no_defs",n)};NeptuneMaps.disableAppropriateControls=function(){$(".disabled-control").each(function(){$(this).is(":checked")&&$(this).trigger("click");$(this).prop("disabled",!0)})};