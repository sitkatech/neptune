@inherits Neptune.WebMvc.Views.Shared.RegionalSubbasin.TraceFromPoint

<div class="leaflet-bottom leaflet-right text-right">
    <button class="btn btn-xs btn-neptune" style="pointer-events:auto" onclick="enterOrExitTraceMode()">View Upstream Area</button>
</div>

<script>
    var mapRef;
    var mapDivID = "@ViewDataTyped.MapDivID"
    var toolTip;
    var arrowHeadsStyle =  {
        frequency: '100px',
        size: '10px',
        fill: true,
        color: '#0099ab',
        fillColor: "#FFFFFF"
    }
    
    var upstreamStyle = {
        fillColor: "#5600FF",
        fill: true,
        fillOpacity: 0.4,
        color: "#5600FF",
        weight: 1,
        stroke: true
    };

    var downstreamStyle = {
        fillColor: "#FF4345",
        fill: true,
        fillOpacity: 0.4,
        color: "#FF4345",
        weight: 1,
        stroke: true
    };

     NeptuneMaps.Map.prototype.rsbTraceFromPoint = function(self, e) {
         self.removeLayerFromMap(self.rsbTraceLayer);
         if (self.traceFromPointMode) {
             jQuery.ajax({
                url: "/RegionalSubbasin/GetRegionalSubbasinGraphTraceAsFeatureCollectionFromPoint",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({"Longitude" : e.latlng.lng, "Latitude" : e.latlng.lat}),
                type: 'POST',
                dataType: 'json',
                jsonpCallback: 'getJson'
             }).then(function(response) {
                 self.rsbTraceLayer = L.geoJson(response.features.sort((a, b) => b.geometry.type.localeCompare(a.geometry.type)),
                                        {
                                            style: function (feature) {
                                                var depth = feature.properties.Depth;
                                                if (feature.geometry.type == "LineString") {
                                                    var depthForWeight = Math.abs(depth) * 0.1;
                                                    return {
                                                        weight: depthForWeight > 2.5 ? 0.5 : 3 - depthForWeight
                                                    }
                                                }

                                                return depth >= 0 ? upstreamStyle : downstreamStyle
                                            },
                                            arrowheads: arrowHeadsStyle
                                        });
                 self.rsbTraceLayer.addTo(self.map);
             });
         }
    };

    NeptuneMaps.Map.prototype.setupTraceFromPoint = function() {
        mapRef = this;
        this.rsbTraceLayer = null;
        this.traceFromPointMode = false;
        debugger;
    }

    function enterOrExitTraceMode() {
        if (mapRef.traceFromPointMode) {
            exitTraceFromPointMode();
            return;
        }

        enterTraceFromPointMode();
    }

    function enterTraceFromPointMode() {
       mapRef.traceFromPointMode = true;
       document.getElementById(mapDivID).style.cursor = 'crosshair';
       mapRef.assignClickEventHandler(mapRef.rsbTraceFromPoint);

       toolTip = L.tooltip({sticky: true, permanent: true}).setLatLng([0,0]).setContent("WHY").addTo(mapRef.map);
       mapRef.map.on('mousemove', (e)=>{
        toolTip.setLatLng(mapRef.map.layerPointToLatLng(e.layerPoint));
       });
    }

    function exitTraceFromPointMode() {
        mapRef.traceFromPointMode = false;
        mapRef.removeLayerFromMap(mapRef.currentMarker);
        mapRef.removeLayerFromMap(mapRef.rsbTraceLayer);
        mapRef.rsbTraceLayer = null;
        document.getElementById(mapDivID).style.cursor = 'default';
        mapRef.removeClickEventHandler(mapRef.rsbTraceFromPoint);
    }

    // function toggleUpstreamRSBTrace() {
    //     if (upstreamRSBTraceLayer) {
    //         map.map.removeLayer(upstreamRSBTraceLayer);
    //         upstreamRSBTraceLayer = null;
    //         jQuery("#toggleUpstreamRSBTraceDisplay").text("View");
    //         jQuery("#rsbTraceUpstreamLegendItem").hide();
    //         if (!downstreamRSBTraceLayer) {
    //             jQuery("#rsbTraceDirectionOfFlowLegendItem").hide();
    //         }
    //         return;
    //     }

    //         jQuery("#toggleUpstreamRSBTraceDisplay").text("Hide");
    //         showRSBLegendItemAndFitBounds();
    // }

    // function showRSBLegendItemAndFitBounds() {
    //     jQuery("#rsbTraceDownstreamLegendItem").show();
    //     jQuery("#rsbTraceDirectionOfFlowLegendItem").show();
    // }
</script>
