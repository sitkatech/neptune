<div class="tb-dialog chatgpt-style">
    <div class="tb-dialog__header">
        <h2 class="tb-dialog__title">
            <img src="./assets/main/icons/esa-ai.svg" alt="AI Icon" />
            Extract Data from Document
        </h2>
    </div>

    @if (currentUser$ | async; as currentUser) {
    <div class="tb-dialog__body | tb-dialog__body--two-col">
        <div class="tb-dialog__main chatgpt-main" #main [scrollTop]="main.scrollHeight">
            <div class="chatgpt-history">
                @if (!messageDto.Messages || messageDto.Messages.length === 0) {
                <div class="intro">
                    <div class="intro__wrapper | copy copy-3">
                        <img src="./assets/main/icons/icon-leaf.svg" alt="Leaf" />
                        <p><strong>Hi!</strong> Choose a prompt or write your own to start extracting data from the document.</p>
                    </div>
                </div>
                } @else { @for (chatMessage of messageDto.Messages; track $index) { @if (chatMessage.Role === 'assistant') {
                <div class="chatgpt-bubble assistant" [id]="'response-' + ($index + 1)">
                    <div class="chatgpt-meta">
                        <span> <img src="./assets/main/icons/esa-ai.svg" alt="AI Icon" class="chatgpt-avatar" /> ESA </span>
                        <span class="chatgpt-date">{{ chatMessage.Date | date : "MMM d, y h:mm a" }}</span>
                    </div>
                    <div class="chatgpt-content">
                        @if (chatMessage.summaryHtml) {
                        <p [innerHTML]="sanitizeSummaryHtml(chatMessage.summaryHtml)"></p>
                        } @else {
                        <p [innerHTML]="sanitizeSummaryHtml(chatMessage.Content)"></p>
                        }
                    </div>
                </div>
                } @else if (chatMessage.Role === 'user') {
                <div class="chatgpt-bubble user">
                    <div class="chatgpt-meta">
                        <span> <icon [icon]="'Leaf'"></icon> {{ currentUser.FirstName + " " + currentUser.LastName }} </span>
                        <span class="chatgpt-date">{{ chatMessage.Date | date : "MMM d, y h:mm a" }}</span>
                    </div>
                    <div class="chatgpt-content">
                        <p>{{ chatMessage.Content }}</p>
                    </div>
                </div>
                } } }
            </div>
        </div>

        <div class="tb-dialog__sidebar chatgpt-sidebar" #sidebar [scrollTop]="sidebar.scrollHeight">
            <div class="tb-dialog__sidebar--body">
                <div class="initial">
                    <h4 class="initial__header">Choose a Prompt</h4>
                    @for (prompt of prompts; track $index) {
                    <div class="option" (click)="selectPrompt(prompt)">
                        <h5 class="option__header | sm-header">Option {{ $index | indexToChar }}</h5>
                        <p class="option__text">{{ prompt }}</p>
                    </div>
                    }
                </div>
            </div>
            <div class="tb-dialog__sidebar--footer">
                <div class="chatgpt-context">
                    <span class="context__badge">
                        <icon [icon]="'File'"></icon>
                        {{ waterQualityManagementPlanDocument.FileResource.OriginalFilename }}
                    </span>
                </div>
                <div class="chatgpt-actions">
                    <a role="button" class="chatgpt-action-link" (click)="reset()">Reset Conversation</a>
                    <a role="button" class="chatgpt-action-link" (click)="exportChat()">Export Chat</a>
                </div>
                @if (isReceiving) {
                <div class="sidebar-loading-indicator">
                    <span class="loading-dots"> <span>.</span><span>.</span><span>.</span> </span>
                </div>
                } @if (messageDto.Messages && messageDto.Messages.length > 0) {
                <div class="chatgpt-nav">
                    <h5 class="chatgpt-nav-header">Jump to Response</h5>
                    @for (chatMessage of messageDto.Messages; track $index) { @if (chatMessage.Role === 'assistant') {
                    <a role="button" class="chatgpt-nav-link" (click)="scrollMainTo('response-' + ($index + 1))"> Response {{ $index + 1 }} </a>
                    } }
                </div>
                }
                <div class="chatgpt-input-bar">
                    <ai-chat-input
                        placeholder="Write your own prompt..."
                        [isReceiving]="isReceiving && !editingIndex"
                        [isDisabled]="editingIndex !== null"
                        (send)="send($event)"></ai-chat-input>
                </div>
            </div>
        </div>
    </div>
    }
</div>
