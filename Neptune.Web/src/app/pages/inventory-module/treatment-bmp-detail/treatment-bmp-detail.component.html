<div class="treatment-bmp-detail">
    <!-- Alerts and Info -->
    @if (!isAnonymousOrUnassigned) { @if (treatmentBMP$ | async; as treatmentBMP) {
    <page-header [pageTitle]="treatmentBMP.TreatmentBMPName" [templateRight]="templateRight" [templateAbove]="templateAbove"></page-header>
    <ng-template #templateRight>
        <!-- Example: Edit/View/Verify actions -->
        <a [routerLink]="getEditLink(treatmentBMP)" class="btn btn-primary mr-2">Edit</a>
        <!-- TODO: Add more actions as needed -->
    </ng-template>
    <ng-template #templateAbove>
        <div class="back">
            <a [routerLink]="['../']" class="back__link">Back to BMP Grid</a>
        </div>
    </ng-template>
    <app-alert-display></app-alert-display>
    @if (delineationErrors?.length) {
    <span>This BMP delineation may have errors:</span>
    <ul>
        @for (err of delineationErrors; track $index) {
        <li>{{ err }}</li>
        }
    </ul>
    } @if (parameterizationErrors?.length) {
    <span>This BMP is not fully parameterized:</span>
    <ul>
        @for (err of parameterizationErrors; track $index) {
        <li>{{ err }}</li>
        }
    </ul>
    } @if (openRevisionRequest) {
    <div class="alert alert-info">There is an open <a [routerLink]="openRevisionRequestDetailUrl">Regional Subbasin Revision Request</a> relating to this BMP.</div>
    } @if (upstreamestBMP && !isUpstreamestBMPAnalyzedInModelingModule) {
    <div class="alert alert-info">This BMP is downstream of a non-modeled BMP, and therefore will not have model results or land use statistics.</div>
    }

    <div class="grid-12">
        <div class="g-col-6">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Basics</span>
                </div>
                <div class="card-body">
                    <dl class="grid-12">
                        <dt class="g-col-5">Name</dt>
                        <dd class="g-col-7">{{ treatmentBMP.TreatmentBMPName }}</dd>
                        <dt class="g-col-5"><field-definition fieldDefinitionType="TreatmentBMPType"></field-definition></dt>
                        <dd class="g-col-7">{{ treatmentBMP.TreatmentBMPTypeName }}</dd>
                        <dt class="g-col-5">Jurisdiction</dt>
                        <dd class="g-col-7">
                            <a [routerLink]="['/jurisdictions', treatmentBMP.StormwaterJurisdictionID]">{{ treatmentBMP.StormwaterJurisdictionName }}</a>
                        </dd>
                        <dt class="g-col-5">Owner</dt>
                        <dd class="g-col-7">
                            <a [routerLink]="['/organizations', treatmentBMP.OwnerOrganizationID]">{{ treatmentBMP.OwnerOrganizationName }}</a>
                        </dd>
                        <dt class="g-col-5">Year Built</dt>
                        <dd class="g-col-7">{{ treatmentBMP.YearBuilt }}</dd>
                        <dt class="g-col-5">ID in System of Record</dt>
                        <dd class="g-col-7">{{ treatmentBMP.SystemOfRecordID }}</dd>
                        <dt class="g-col-5">Water Quality Management Plan</dt>
                        <dd class="g-col-7">
                            @if (treatmentBMP.WaterQualityManagementPlan) {
                            <a [routerLink]="['/wqmps', treatmentBMP.WaterQualityManagementPlanID]">{{ treatmentBMP.WaterQualityManagementPlan.WaterQualityManagementPlanName }}</a>
                            } @else {
                            <em class="text-muted">Has not been linked to a WQMP</em>
                            }
                        </dd>
                        <dt class="g-col-5"><field-definition fieldDefinitionType="SizingBasis"></field-definition></dt>
                        <dd class="g-col-7">{{ treatmentBMP.SizingBasisType.SizingBasisTypeDisplayName }}</dd>
                        <dt class="g-col-5"><field-definition fieldDefinitionType="TrashCaptureStatus"></field-definition></dt>
                        <dd class="g-col-7">{{ treatmentBMP.TrashCaptureStatusType.TrashCaptureStatusTypeDisplayName }}</dd>
                        @if (false) {
                        <dt class="g-col-5">Trash Capture Effectiveness</dt>
                        <dd class="g-col-7">{{ treatmentBMP.TrashCaptureEffectiveness }}</dd>
                        }
                        <dt class="g-col-5"><field-definition fieldDefinitionType="RequiredLifespanOfInstallation"></field-definition></dt>
                        <dd class="g-col-7">
                            @if (treatmentBMP.TreatmentBMPLifespanType?.TreatmentBMPLifeSpanTypeID == TreatmentBMPLifespanTypeEnum.FixedEndDate) { Maintain until at least
                            {{ treatmentBMP.TreatmentBMPLifespanEndDate | date : "MM/dd/yyyy" }}
                            } @else {
                            {{ treatmentBMP.TreatmentBMPLifespanType?.TreatmentBMPLifeSpanTypeDisplayName || "Unknown" }}
                            }
                        </dd>
                        <dt class="g-col-5"><field-definition fieldDefinitionType="RequiredFieldVisitsPerYear"></field-definition></dt>
                        <dd class="g-col-7">{{ treatmentBMP.RequiredFieldVisitsPerYear }}</dd>
                        <dt class="g-col-5"><field-definition fieldDefinitionType="RequiredPostStormFieldVisitsPerYear"></field-definition></dt>
                        <dd class="g-col-7">{{ treatmentBMP.RequiredPostStormFieldVisitsPerYear }}</dd>
                        <dt class="g-col-5">Notes</dt>
                        <dd class="g-col-7">{{ treatmentBMP.Notes }}</dd>
                    </dl>
                </div>
            </div>
            <!-- Model Results -->
            @if (isAnalyzedInModelingModule) {
            <div class="mt-3 mb-3">
                <div class="card">
                    <div class="card-header"><span class="card-title">Model Results</span></div>
                    <div class="card-body">
                        <!-- TODO: Add modeled performance fields -->
                    </div>
                </div>
            </div>
            }
        </div>

        <!-- Map and Images -->
        <div class="g-col-6">
            <div class="card">
                <div class="card-header"><span class="card-title">Location & Map</span></div>
                <div class="card-body">
                    @if (treatmentBMP$ | async; as treatmentBMP) {
                    <neptune-map [mapHeight]="'400px'" [showLegend]="false" [boundingBox]="boundingBox" (onMapLoad)="handleMapReady($event)">
                        @if (mapIsReady) {
                        <regional-subbasins-layer [displayOnLoad]="false" [map]="map" [layerControl]="layerControl" [sortOrder]="10"></regional-subbasins-layer>
                        } @if (mapIsReady) {
                        <stormwater-network-layer [displayOnLoad]="false" [map]="map" [layerControl]="layerControl" [sortOrder]="20"></stormwater-network-layer>
                        } @if (mapIsReady) {
                        <jurisdictions-layer [displayOnLoad]="false" [map]="map" [layerControl]="layerControl" [sortOrder]="30"></jurisdictions-layer>
                        } @if (mapIsReady) {
                        <wqmps-layer [displayOnLoad]="false" [map]="map" [layerControl]="layerControl" [sortOrder]="40"></wqmps-layer>
                        } @if (mapIsReady) {
                        <delineations-layer [displayOnLoad]="false" [map]="map" [layerControl]="layerControl" [sortOrder]="50"></delineations-layer>
                        } @if (mapIsReady) {
                        <inventoried-bmps-layer [displayOnLoad]="false" [map]="map" [layerControl]="layerControl" [sortOrder]="60"></inventoried-bmps-layer>
                        }
                    </neptune-map>
                    }
                </div>
            </div>
            <div class="card mt-2">
                <div class="card-header"><span class="card-title">Images</span></div>
                <div class="card-body">
                    <!-- TODO: Add image carousel/gallery here -->
                </div>
            </div>
        </div>
    </div>

    } }
</div>
