<h1>WQMP PDF Extraction via AI</h1>
<div class="ai-home grid-12">
    <div class="step g-col-12 grid-12">
        <div class="step-header g-col-12 mt-4">
            <span class="step-circle">1</span>
            <h3>Select a Water Quality Management Plan</h3>
        </div>
        <div class="plan-selector g-col-4">
            <form-field [formControl]="planControl" [formInputOptions]="waterQualityManagementPlans$ | async" [type]="FormFieldType.Select" name="planSelect"></form-field>
        </div>
        <div class="g-col-2">
            <!-- Spacer -->
        </div>
        @if (selectedPlan$ | async; as selectedPlan) {
            <div class="selected-plan-preview g-col-6 grid-12">
                @if (selectedPlan.WaterQualityManagementPlanBoundaryBBox) {
                    <div class="location-preview g-col-2">
                        @if (imagePreview$ | async; as preview) {
                            <img [src]="preview" alt="WQMP Preview Image" />
                        }
                    </div>
                }
                <div class="g-col-10">
                    <h3>{{ selectedPlan?.WaterQualityManagementPlanName }}</h3>
                    <div class="jurisdiction-organization-name mb-3">{{ selectedPlan?.StormwaterJurisdictionOrganizationName }}</div>
                    <a class="view-detail-page-link" href="{{ ocStormwaterToolsMainUrl() }}/WaterQualityManagementPlan/Detail/{{ selectedPlan?.WaterQualityManagementPlanID }}"
                        >View WQMP Detail Page</a
                    >
                </div>
            </div>
        }
    </div>

    @if (selectedPlan$ | async; as selectedPlan) {
        <hr />

        <div class="step g-col-12 grid-12">
            <div class="step-header g-col-12">
                <span class="step-circle">2</span>
                <h3>Extract Data with AI</h3>
            </div>

            <div class="g-col-6">
                <button class="btn btn-blue" (click)="onClickExtractData()" [disabled]="!selectedDocument"><icon icon="Stars"></icon> Run Data Extraction</button>
            </div>

            <div class="g-col-6">
                <water-quality-management-plan-documents
                    [waterQualityManagementPlanID]="selectedPlan.WaterQualityManagementPlanID"
                    [activeChatbotDocument]="activeChatbotDocument"
                    (documentSelectedChange)="onDocumentSelectedChange($event)"
                    (extractingChange)="onExtractingChange($event)"></water-quality-management-plan-documents>
            </div>
        </div>
        @if (activeChatbotDocument) {
            <hr />
            <div class="step g-col-12 grid-12">
                <div class="step-header g-col-12">
                    <span class="step-circle">3</span>
                    <h3>Review Output</h3>
                </div>
                <div class="extracted-data-panel grid-12 g-col-12" [loadingSpinner]="{ isLoading: isExtracting, loadingHeight: 100 }">
                    @if (!isExtracting) {
                        <div class="extracted-basic-data card g-col-6">
                            <div class="card-header">
                                <h5 class="card-title">Basics</h5>
                                <div class="tag blue"><icon icon="Stars"></icon> AI Extracted Data</div>
                            </div>
                            <div class="card-body grid-12">
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">Name</label>
                                    <div class="g-col-8">
                                        {{ finalOutputObject?.WQMP?.WaterQualityManagementPlanName?.Value ?? "" }}
                                        @if (finalOutputObject?.WQMP?.WaterQualityManagementPlanName?.Value) {
                                            <span class="view-source" (click)="onViewSource('Name', finalOutputObject.WQMP.WaterQualityManagementPlanName)">(View Source)</span>
                                        }
                                    </div>
                                </div>
                                @if (finalOutputObject.WQMP.WaterQualityManagementPlanName.$showSource) {
                                    <div class="field-source g-col-12 grid-12">
                                        <div class="g-col-2"></div>
                                        <label class="g-col-4">Document Source</label>
                                        <div class="g-col-6">
                                            {{ finalOutputObject?.WQMP?.WaterQualityManagementPlanName?.DocumentSource ?? "" }}
                                        </div>
                                        <div class="g-col-2"></div>
                                        <label class="g-col-4">Evidence</label>
                                        <div class="g-col-6">
                                            {{ finalOutputObject?.WQMP?.WaterQualityManagementPlanName?.ExtractionEvidence ?? "" }}
                                        </div>
                                    </div>
                                }
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">Jurisdiction</label>
                                    <div class="g-col-8">
                                        {{ finalOutputObject?.WQMP?.Jurisdiction?.Value ?? "" }}
                                        @if (finalOutputObject?.WQMP?.Jurisdiction?.Value) {
                                            <span class="view-source" (click)="onViewSource('Jurisdiction', finalOutputObject.WQMP.Jurisdiction)">(View Source)</span>
                                        }
                                    </div>
                                </div>
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">Priority</label>
                                    <div class="g-col-8">
                                        {{ finalOutputObject?.WQMP?.WaterQualityManagementPlanPriority?.Value ?? "" }}
                                        @if (finalOutputObject?.WQMP?.WaterQualityManagementPlanPriority?.Value) {
                                            <span class="view-source" (click)="onViewSource('Priority', finalOutputObject.WQMP.WaterQualityManagementPlanPriority)"
                                                >(View Source)</span
                                            >
                                        }
                                    </div>
                                </div>
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">Status</label>
                                    <div class="g-col-8">
                                        {{ finalOutputObject?.WQMP?.WaterQualityManagementPlanStatus?.Value ?? "" }}
                                        @if (finalOutputObject?.WQMP?.WaterQualityManagementPlanStatus?.Value) {
                                            <span class="view-source" (click)="onViewSource('Status', finalOutputObject.WQMP.WaterQualityManagementPlanStatus)">(View Source)</span>
                                        }
                                    </div>
                                </div>
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">Development Type</label>
                                    <div class="g-col-8">
                                        {{ finalOutputObject?.WQMP?.WaterQualityManagementPlanDevelopmentType?.Value ?? "" }}
                                        @if (finalOutputObject?.WQMP?.WaterQualityManagementPlanDevelopmentType?.Value) {
                                            <span class="view-source" (click)="onViewSource('Development Type', finalOutputObject.WQMP.WaterQualityManagementPlanDevelopmentType)"
                                                >(View Source)</span
                                            >
                                        }
                                    </div>
                                </div>
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">Land Use</label>
                                    <div class="g-col-8">
                                        {{ finalOutputObject?.WQMP?.WaterQualityManagementPlanLandUse?.Value ?? "" }}
                                        @if (finalOutputObject?.WQMP?.WaterQualityManagementPlanLandUse?.Value) {
                                            <span class="view-source" (click)="onViewSource('Land Use', finalOutputObject.WQMP.WaterQualityManagementPlanLandUse)"
                                                >(View Source)</span
                                            >
                                        }
                                    </div>
                                </div>
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">Permit Term</label>
                                    <div class="g-col-8">
                                        {{ finalOutputObject?.WQMP?.WaterQualityManagementPlanPermitTerm?.Value ?? "" }}
                                        @if (finalOutputObject?.WQMP?.WaterQualityManagementPlanPermitTerm?.Value) {
                                            <span class="view-source" (click)="onViewSource('Permit Term', finalOutputObject.WQMP.WaterQualityManagementPlanPermitTerm)"
                                                >(View Source)</span
                                            >
                                        }
                                    </div>
                                </div>
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">Approval Date</label>
                                    <div class="g-col-8">
                                        {{ finalOutputObject?.WQMP?.ApprovalDate?.Value ?? "" }}
                                        @if (finalOutputObject?.WQMP?.ApprovalDate?.Value) {
                                            <span class="view-source" (click)="onViewSource('Approval Date', finalOutputObject.WQMP.ApprovalDate)">(View Source)</span>
                                        }
                                    </div>
                                </div>
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">Date of Construction</label>
                                    <div class="g-col-8">
                                        {{ finalOutputObject?.WQMP?.DateOfConstruction?.Value ?? "" }}
                                        @if (finalOutputObject?.WQMP?.DateOfConstruction?.Value) {
                                            <span class="view-source" (click)="onViewSource('Date of Construction', finalOutputObject.WQMP.DateOfConstruction)">(View Source)</span>
                                        }
                                    </div>
                                </div>
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">Hydromodification Controls Apply</label>
                                    <div class="g-col-8">
                                        {{ finalOutputObject?.WQMP?.HydromodificationAppliesType?.Value ?? "" }}
                                        @if (finalOutputObject?.WQMP?.HydromodificationAppliesType?.Value) {
                                            <span
                                                class="view-source"
                                                (click)="onViewSource('Hydromodification Controls Apply', finalOutputObject.WQMP.HydromodificationAppliesType)"
                                                >(View Source)</span
                                            >
                                        }
                                    </div>
                                </div>
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">Hydrologic Subarea</label>
                                    <div class="g-col-8">
                                        {{ finalOutputObject?.WQMP?.HydrologicSubarea?.Value ?? "" }}
                                        @if (finalOutputObject?.WQMP?.HydrologicSubarea?.Value) {
                                            <span class="view-source" (click)="onViewSource('Hydrologic Subarea', finalOutputObject.WQMP.HydrologicSubarea)">(View Source)</span>
                                        }
                                    </div>
                                </div>
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">Record Number</label>
                                    <div class="g-col-8">
                                        {{ finalOutputObject?.WQMP?.RecordNumber?.Value ?? "" }}
                                        @if (finalOutputObject?.WQMP?.RecordNumber?.Value) {
                                            <span class="view-source" (click)="onViewSource('Record Number', finalOutputObject.WQMP.RecordNumber)">(View Source)</span>
                                        }
                                    </div>
                                </div>
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">Recorded WQMP Area (Acres)</label>
                                    <div class="g-col-8">
                                        {{ finalOutputObject?.WQMP?.RecordedWQMPAreaInAcres?.Value ?? "" }}
                                        @if (finalOutputObject?.WQMP?.RecordedWQMPAreaInAcres?.Value) {
                                            <span class="view-source" (click)="onViewSource('Recorded WQMP Area (Acres)', finalOutputObject.WQMP.RecordedWQMPAreaInAcres)"
                                                >(View Source)</span
                                            >
                                        }
                                    </div>
                                </div>
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">Trash Capture Status</label>
                                    <div class="g-col-8">
                                        {{ finalOutputObject?.WQMP?.TrashCaptureStatusType?.Value ?? "" }}
                                        @if (finalOutputObject?.WQMP?.TrashCaptureStatusType?.Value) {
                                            <span class="view-source" (click)="onViewSource('Trash Capture Status', finalOutputObject.WQMP.TrashCaptureStatusType)"
                                                >(View Source)</span
                                            >
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="existing-basic-data card g-col-6">
                            <div class="card-header">
                                <h5 class="card-title">Basics</h5>
                                <div class="tag orange">OCST Existing WQMP Data</div>
                            </div>
                            <div class="card-body grid-12">
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">Name</label>
                                    <div class="g-col-8">{{ selectedPlan.WaterQualityManagementPlanName }}</div>
                                </div>
                                <div class="field grid-12">
                                    <label class="g-col-4">Jurisdiction</label>
                                    <div class="g-col-8">{{ selectedPlan.StormwaterJurisdictionOrganizationName }}</div>
                                </div>
                                <div class="field grid-12">
                                    <label class="g-col-4">Priority</label>
                                    <div class="g-col-8">{{ selectedPlan.WaterQualityManagementPlanPriorityDisplayName }}</div>
                                </div>
                                <div class="field grid-12">
                                    <label class="g-col-4">Status</label>
                                    <div class="g-col-8">{{ selectedPlan.WaterQualityManagementPlanStatusDisplayName }}</div>
                                </div>
                                <div class="field grid-12">
                                    <label class="g-col-4">Development Type</label>
                                    <div class="g-col-8">{{ selectedPlan.WaterQualityManagementPlanDevelopmentTypeDisplayName }}</div>
                                </div>
                                <div class="field grid-12">
                                    <label class="g-col-4">Land Use</label>
                                    <div class="g-col-8">{{ selectedPlan.WaterQualityManagementPlanLandUseDisplayName }}</div>
                                </div>
                                <div class="field grid-12">
                                    <label class="g-col-4">Permit Term</label>
                                    <div class="g-col-8">{{ selectedPlan.WaterQualityManagementPlanPermitTermDisplayName }}</div>
                                </div>
                                <div class="field grid-12">
                                    <label class="g-col-4">Approval Date</label>
                                    <div class="g-col-8">{{ selectedPlan.ApprovalDate | date: "MM/dd/yyyy" }}</div>
                                </div>
                                <div class="field grid-12">
                                    <label class="g-col-4">Date of Construction</label>
                                    <div class="g-col-8">{{ selectedPlan.DateOfConstruction | date: "MM/dd/yyyy" }}</div>
                                </div>
                                <div class="field grid-12">
                                    <label class="g-col-4">Hydromodification Controls Apply</label>
                                    <div class="g-col-8">{{ selectedPlan.HydromodificationAppliesTypeDisplayName }}</div>
                                </div>
                                <div class="field grid-12">
                                    <label class="g-col-4">Hydrologic Subarea</label>
                                    <div class="g-col-8">{{ selectedPlan.HydrologicSubareaName }}</div>
                                </div>
                                <div class="field grid-12">
                                    <label class="g-col-4">Record Number</label>
                                    <div class="g-col-8">{{ selectedPlan.RecordNumber }}</div>
                                </div>
                                <div class="field grid-12">
                                    <label class="g-col-4">Recorded WQMP Area (Acres)</label>
                                    <div class="g-col-8">{{ selectedPlan.RecordedWQMPAreaInAcres }}</div>
                                </div>
                                <div class="field grid-12">
                                    <label class="g-col-4">Trash Capture Status</label>
                                    <div class="g-col-8">{{ selectedPlan.TrashCaptureStatusTypeDisplayName }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="extracted-parcel card g-col-6">
                            <div class="card-header">
                                <h5 class="card-title">Associated Parcels</h5>
                                <div class="tag blue"><icon icon="Stars"></icon> AI Extracted Data</div>
                            </div>
                            <div class="card-body grid-12">
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">Parcels</label>
                                    <div class="g-col-8">
                                        <ul>
                                            @for (parcel of finalOutputObject?.Parcels || []; track parcel.ParcelNumber) {
                                                <li>
                                                    {{ parcel.ParcelNumber?.Value || "" }}
                                                    <span class="view-source" (click)="onViewSource('Parcel Number', parcel.ParcelNumber)">(View Source)</span>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="existing-parcel card g-col-6">
                            <div class="card-header">
                                <h5 class="card-title">Associated Parcels</h5>
                                <div class="tag orange">OCST Existing WQMP Data</div>
                            </div>

                            <div class="card-body grid-12">
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">Parcels</label>
                                    <div class="g-col-8">
                                        <ul>
                                            @for (parcel of selectedPlan.Parcels; track parcel.ParcelID) {
                                                <li>
                                                    {{ parcel.ParcelNumber }}
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="extracted-parcel card g-col-6">
                            <div class="card-header">
                                <h5 class="card-title">BMPs</h5>
                                <div class="tag blue"><icon icon="Stars"></icon> AI Extracted Data</div>
                            </div>
                            <div class="card-body grid-12">
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">BMPs</label>
                                    <div class="g-col-8">
                                        <ul>
                                            @for (bmp of finalOutputObject?.TreatmentBMPs || []; track bmp.TreatmentBMPName) {
                                                <li>
                                                    {{ bmp.TreatmentBMPName?.Value || "" }}
                                                    @if (bmp.Area?.Value) {
                                                        ({{ bmp.Area?.Value }})
                                                    }
                                                    <span class="view-source" (click)="onViewSource('BMP', bmp.TreatmentBMPName)">(View Source)</span>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="existing-parcel card g-col-6">
                            <div class="card-header">
                                <h5 class="card-title">BMPs</h5>
                                <div class="tag orange">OCST Existing WQMP Data</div>
                            </div>
                            <div class="card-body grid-12">
                                <div class="field g-col-12 grid-12">
                                    <label class="g-col-4">BMPs</label>
                                    <div class="g-col-8">
                                        <ul>
                                            @for (bmp of selectedPlan.TreatmentBMPs; track bmp.TreatmentBMPID) {
                                                <li>
                                                    {{ bmp.TreatmentBMPName }}
                                                    @if (bmp.Area) {
                                                        ({{ bmp.Area }} acres)
                                                    }
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                @if (isExtracting) {
                    <div class="extracting-text mb-4">{{ extractingTexts[currentExtractingTextIndex] }}<span>.</span><span>.</span><span>.</span></div>
                }
            </div>
        }
    }
</div>

<div
    class="chatgpt-open"
    [ngClass]="{ disabled: !activeChatbotDocument || isExtracting }"
    (click)="toggleChatbot()"
    [title]="activeChatbotDocument && !isExtracting ? (isChatbotOpen ? 'Close AI Chatbot' : 'Open AI Chatbot') : 'Select a document to enable the AI Chatbot'">
    <icon icon="Stars" [enableFontSize]="true"></icon>
</div>

@if (activeChatbotDocument) {
    <div class="chatbox-section g-col-12 grid-12" [ngClass]="{ open: isChatbotOpen }" #chatbotSection>
        <div class="section-header g-col-12">
            <h3><icon icon="Stars"></icon> Ask the AI</h3>
        </div>
        <div class="extracted-data-panel g-col-12" [loadingSpinner]="{ isLoading: isExtracting, loadingHeight: 100 }">
            <water-quality-management-plan-chatbot [waterQualityManagementPlanDocument]="activeChatbotDocument" [extractionResult]="extractionResult">
            </water-quality-management-plan-chatbot>
        </div>
    </div>
}
